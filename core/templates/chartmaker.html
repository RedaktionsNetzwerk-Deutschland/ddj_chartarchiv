{% extends 'base.html' %}

{% block title %}Chartmaker - RND-Grafikarchiv{% endblock %}

{% block content %}
  {% include 'partials/header.html' %}
  
  <style>
    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #4f80ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>

  <!-- Spinner Overlay -->
  <div class="spinner-overlay" id="spinner">
    <div class="spinner"></div>
  </div>
  
  <div style="max-width: 1200px; margin: 40px auto; padding: 0 20px;">
    <h1 style="font-family: 'DINNextLTPro', sans-serif; font-size: 2.5em; color: #333;">Chartmaker</h1>
    
    <div style="margin-top: 40px;">
      <h2 style="font-family: 'DINNextLTPro', sans-serif; font-size: 1.8em; color: #333; margin-bottom: 20px;">
        Daten einfügen
      </h2>
      
      <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: center;">
        <!-- Copy-Paste Bereich -->
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative;">
          <h3 style="font-family: 'DINNextLTPro', sans-serif; font-size: 1.2em; color: #666; margin-bottom: 15px;">
            Daten kopieren & einfügen
          </h3>
          <textarea 
            id="data-input"
            placeholder="Füge hier deine Daten ein (z.B. aus Excel oder Google Sheets)..."
            style="
              width: 100%;
              min-height: 200px;
              padding: 15px;
              border: 1px solid #ddd;
              border-radius: 4px;
              font-family: monospace;
              font-size: 14px;
              resize: vertical;
              box-sizing: border-box;
            "
          ></textarea>
          <button 
            id="submit-button" 
            style="
              position: absolute;
              bottom: 30px;
              right: 30px;
              padding: 10px 20px;
              background-color: #4f80ff;
              color: white;
              border: none;
              border-radius: 4px;
              font-family: 'DINNextLTPro', sans-serif;
              cursor: pointer;
              display: none;
              transition: all 0.3s ease;
            "
            onclick="handlePastedData()"
          >
            abschicken
          </button>
        </div>

        <!-- ODER Trenner -->
        <div style="
          font-family: 'DINNextLTPro', sans-serif;
          font-size: 1.2em;
          color: #666;
          text-align: center;
          position: relative;
          padding: 0 20px;
        ">
          <div style="
            background: #f2f2f2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
          ">
            oder
          </div>
        </div>
        
        <!-- Upload Bereich -->
        <div style="
          background: white;
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          border: 2px dashed #ddd;
        ">
          <h3 style="font-family: 'DINNextLTPro', sans-serif; font-size: 1.2em; color: #666; margin-bottom: 15px; text-align: center;">
            Datei hochladen
          </h3>
          
          <div style="text-align: center;">
            <form id="upload-form" enctype="multipart/form-data">
              <input type="file" id="file-upload" name="file" accept=".csv,.xlsx" style="display: none;">
              <label for="file-upload" style="
                display: inline-block;
                padding: 12px 24px;
                background: #4f80ff;
                color: white;
                border-radius: 4px;
                cursor: pointer;
                font-family: 'DINNextLTPro', sans-serif;
                transition: all 0.3s ease;
              ">
                Datei auswählen
              </label>
              <div style="margin-top: 15px; color: #666; font-size: 0.9em;">
                <p style="margin-bottom: 8px; font-weight: 500;">
                  Nur CSV- und Excel-Dateien (.xlsx)
                </p>
                <p style="margin-top: 0; color: #888; font-size: 0.85em;">
                  Bitte stelle sicher, dass deine Daten in einem strukturierten Format vorliegen
                </p>
                <div style="
                  display: flex;
                  justify-content: center;
                  gap: 15px;
                  margin-top: 10px;
                  font-size: 0.85em;
                ">
                  <span style="
                    display: inline-flex;
                    align-items: center;
                    padding: 3px 10px;
                    background-color: #f0f2f5;
                    border-radius: 20px;
                  ">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px;">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                      <polyline points="14 2 14 8 20 8"></polyline>
                      <line x1="16" y1="13" x2="8" y2="13"></line>
                      <line x1="16" y1="17" x2="8" y2="17"></line>
                      <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    CSV
                  </span>
                  <span style="
                    display: inline-flex;
                    align-items: center;
                    padding: 3px 10px;
                    background-color: #e9f7ef;
                    border-radius: 20px;
                    color: #27ae60;
                  ">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px;">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                      <polyline points="14 2 14 8 20 8"></polyline>
                      <rect x="8" y="12" width="8" height="6"></rect>
                    </svg>
                    XLSX
                  </span>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Analyse-Bereich -->
      <div id="analysis-container" style="
        margin-top: 40px;
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: none;
      ">
        <h3 style="font-family: 'DINNextLTPro', sans-serif; font-size: 1.4em; color: #333; margin-bottom: 20px;">
          Datenverarbeitung
        </h3>

        <!-- Chat-Container -->
        <div id="chat-container" style="
          display: flex;
          flex-direction: column;
          gap: 20px;
          margin-bottom: 30px;
        ">
          <!-- Erfolgsmeldung -->
          <div class="message-container" style="
            display: flex;
            justify-content: flex-start;
            width: 100%;
          ">
            <div class="message gpt-message" style="
              width: 60%;
              background: #f5f5f5;
              padding: 20px;
              border-radius: 8px;
              font-family: 'Source Serif Pro', serif;
              line-height: 1.6;
              color: #333;
            ">
              <div id="success-message" style="
                display: flex;
                align-items: center;
                gap: 12px;
              ">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#4CAF50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                <span>Daten erfolgreich hochgeladen! Hier eine Vorschau (max. 10 Zeilen).</span>
              </div>
            </div>
          </div>

          <!-- App Nachricht mit Buttons -->
          <div class="message-container" style="
            display: flex;
            justify-content: flex-start;
            width: 100%;
            margin-top: 15px;
          ">
            <div class="message gpt-message" style="
              width: 60%;
              background: #f5f5f5;
              padding: 20px;
              border-radius: 8px;
              font-family: 'Source Serif Pro', serif;
              line-height: 1.6;
              color: #333;
            ">
              <p>Was möchtest du mit diesen Daten tun?</p>
            </div>
          </div>

          <!-- Auswahlbuttons (rechts positioniert wie Nutzereingabe) -->
          <div class="message-container" style="
            display: flex;
            justify-content: flex-end;
            width: 100%;
            margin-top: 10px;
          ">
            <div style="
              width: 60%;
              background: #e3f2fd;
              padding: 20px;
              border-radius: 8px;
              box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            ">
              <div style="
                display: flex;
                gap: 10px;
                align-items: center;
              ">
                <button onclick="handleUserChoice('analyze')" style="
                  flex: 1;
                  padding: 12px 18px;
                  background-color: #f0f2f5;
                  color: #333;
                  border: none;
                  border-radius: 20px;
                  font-family: 'DINNextLTPro', sans-serif;
                  font-weight: 500;
                  cursor: pointer;
                  transition: all 0.2s ease;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 8px;
                ">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                  </svg>
                  Analysiere / Bearbeite
                </button>
                <button onclick="handleUserChoice('create')" style="
                  flex: 1;
                  padding: 12px 18px;
                  background-color: #4f80ff;
                  color: white;
                  border: none;
                  border-radius: 20px;
                  font-family: 'DINNextLTPro', sans-serif;
                  font-weight: 500;
                  cursor: pointer;
                  transition: all 0.2s ease;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 8px;
                ">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                  Baue Grafik
                </button>
              </div>
            </div>
          </div>

          <!-- Analyse-Ergebnis -->
          <div id="analysis-result-container" class="message-container" style="
            display: none;
            justify-content: flex-start;
            width: 100%;
            margin-top: 20px;
          ">
            <div class="message gpt-message" style="
              width: 60%;
              background: #f5f5f5;
              padding: 20px;
              border-radius: 8px;
              font-family: 'Source Serif Pro', serif;
              line-height: 1.6;
              color: #333;
              white-space: pre-wrap;
            ">
              <div id="analysis-content"></div>
            </div>
          </div>
        </div>

        <!-- Eingabefeld für Nutzerantwort -->
        <div class="user-input-container" style="
          display: none;
          justify-content: flex-end;
          width: 100%;
          margin-top: 20px;
        " id="free-text-container">
          <div style="width: 60%;">
            <textarea id="user-input" style="
              width: 100%;
              min-height: 100px;
              padding: 15px;
              border: 1px solid #ddd;
              border-radius: 8px;
              font-family: 'Source Serif Pro', serif;
              font-size: 1em;
              resize: vertical;
              margin-bottom: 10px;
            " placeholder="Stelle hier deine Frage an ChatGPT..."></textarea>
            <button onclick="sendToChatGPT()" style="
              float: right;
              padding: 10px 20px;
              background-color: #4f80ff;
              color: white;
              border: none;
              border-radius: 4px;
              font-family: 'DINNextLTPro', sans-serif;
              cursor: pointer;
              transition: all 0.3s ease;
            ">Senden</button>
          </div>
        </div>

        <!-- Analyse-Bereich (versteckt bis "Analysieren" ausgewählt wird) -->
        <div id="analysis-details-container" style="display: none;">
          <!-- Warnungen -->
          <div id="warnings-container" style="margin-top: 30px;">
            <!-- Info-Warnungen -->
            <div id="info-warnings" style="
              margin-bottom: 10px;
              padding: 10px 15px;
              background: #e3f2fd;
              border-radius: 4px;
              border-left: 4px solid #2196f3;
              display: none;
            ">
              <div id="info-warnings-content" style="
                color: #1565c0;
                font-family: 'DINNextLTPro', sans-serif;
                font-size: 0.9em;
              "></div>
            </div>

            <!-- Wichtige Warnungen -->
            <div id="important-warnings" style="
              margin-bottom: 10px;
              padding: 10px 15px;
              background: #fff3e0;
              border-radius: 4px;
              border-left: 4px solid #ff9800;
              display: none;
            ">
              <div id="important-warnings-content" style="
                color: #e65100;
                font-family: 'DINNextLTPro', sans-serif;
                font-size: 0.9em;
              "></div>
            </div>
          </div>

          <!-- Metadaten-Bereich -->
          <div id="metadata-container" style="margin-top: 30px;">
            <!-- Header Metadaten -->
            <div id="header-metadata" style="
              margin-bottom: 20px;
              padding: 15px;
              background: #f8f9fa;
              border-radius: 4px;
              display: none;
            ">
              <h4 style="font-family: 'DINNextLTPro', sans-serif; font-size: 1.1em; color: #666; margin-bottom: 10px;">
                Gefundene Metadaten am Dateianfang:
              </h4>
              <div id="header-metadata-content" style="
                font-family: monospace;
                font-size: 0.9em;
                color: #666;
                white-space: pre-wrap;
              "></div>
            </div>

            <!-- Footer Metadaten -->
            <div id="footer-metadata" style="
              margin-bottom: 20px;
              padding: 15px;
              background: #f8f9fa;
              border-radius: 4px;
              display: none;
            ">
              <h4 style="font-family: 'DINNextLTPro', sans-serif; font-size: 1.1em; color: #666; margin-bottom: 10px;">
                Gefundene Fußnoten:
              </h4>
              <div id="footer-metadata-content" style="
                font-family: monospace;
                font-size: 0.9em;
                color: #666;
                white-space: pre-wrap;
              "></div>
            </div>
          </div>
        </div>

      </div>

    </div>
  </div>

  <script>
    // Drag & Drop Funktionalität
    const dropZone = document.querySelector('input[type="file"]').parentElement.parentElement;
    
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = '#4f80ff';
      dropZone.style.backgroundColor = '#f8f9ff';
    });
    
    dropZone.addEventListener('dragleave', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = '#ddd';
      dropZone.style.backgroundColor = 'white';
    });
    
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = '#ddd';
      dropZone.style.backgroundColor = 'white';
      
      const files = e.dataTransfer.files;
      if (files.length) {
        const fileInput = document.getElementById('file-upload');
        fileInput.files = files;
        handleFileUpload(fileInput.files[0]);
      }
    });

    // Hover-Effekt für den Upload-Button
    const uploadLabel = document.querySelector('label[for="file-upload"]');
    uploadLabel.addEventListener('mouseover', () => {
      uploadLabel.style.backgroundColor = '#3a6cd9';
    });
    uploadLabel.addEventListener('mouseout', () => {
      uploadLabel.style.backgroundColor = '#4f80ff';
    });

    // Datei-Upload Handler
    document.getElementById('file-upload').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        handleFileUpload(file);
      }
    });

    // Event-Listener für die Enter-Taste im Eingabefeld
    document.addEventListener('DOMContentLoaded', function() {
      const userInput = document.getElementById('user-input');
      if (userInput) {
        userInput.addEventListener('keydown', function(event) {
          // Wenn Enter gedrückt wurde und nicht gleichzeitig Shift (für Zeilenumbrüche)
          if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault(); // Verhindere den Standard-Zeilenumbruch
            sendToChatGPT(); // Sende die Nachricht
          }
        });
      }
    });

    // Neue Funktionen für die Textfeld-Verarbeitung
    document.getElementById('data-input').addEventListener('input', function() {
        const submitButton = document.getElementById('submit-button');
        if (this.value.trim()) {
            submitButton.style.display = 'block';
        } else {
            submitButton.style.display = 'none';
        }
    });

    // Funktion zum Scrollen zum Analyse-Container
    function scrollToAnalysisContainer() {
      // Hole den Analyse-Container
      const analysisContainer = document.getElementById('analysis-container');
      
      // Scrolle mit Animation zum Container
      setTimeout(() => {
        analysisContainer.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'start' 
        });
      }, 100);
    }

    // Funktion zum Hinzufügen einer neuen Nachricht zum Chat
    function addMessageToChat(content, isGPT = true) {
      const chatContainer = document.getElementById('chat-container');
      if (!chatContainer) {
        console.error("Chat-Container nicht gefunden!");
        return;
      }
      
      // Erstelle das Nachrichten-Element
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message-container';
      messageDiv.style.display = 'flex';
      messageDiv.style.justifyContent = isGPT ? 'flex-start' : 'flex-end';
      messageDiv.style.width = '100%';
      messageDiv.style.marginTop = '15px';
      
      // Erstelle den Inhalt der Nachricht
      const messageContent = document.createElement('div');
      messageContent.className = isGPT ? 'message gpt-message' : 'message user-message';
      messageContent.style.width = '60%';
      messageContent.style.padding = '20px';
      messageContent.style.borderRadius = '8px';
      messageContent.style.fontFamily = "'Source Serif Pro', serif";
      messageContent.style.lineHeight = '1.6';
      messageContent.style.color = '#333';
      messageContent.style.whiteSpace = 'pre-wrap';
      
      if (isGPT) {
        messageContent.style.background = '#f5f5f5';
      } else {
        messageContent.style.background = '#e3f2fd';
      }
      
      // Füge den Text hinzu
      messageContent.textContent = content;
      
      // Füge alles zusammen und zum Chat hinzu
      messageDiv.appendChild(messageContent);
      chatContainer.appendChild(messageDiv);
      
      console.log("Nachricht zum Chat hinzugefügt:", { 
        isGPT: isGPT, 
        contentLength: content.length,
        messageElement: messageDiv 
      });
      
      // Intelligentes Scrollen zu neuen Nachrichten
      // Nur scrollen, wenn der Nutzer nicht aktiv nach oben gescrollt hat
      if (shouldAutoScroll()) {
        setTimeout(() => {
          messageDiv.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'end' 
          });
        }, 100);
      }
    }

    // Variablen für intelligentes Scroll-Tracking
    let userHasScrolled = false;
    let lastScrollTop = 0;
    
    // Event-Listener für Scroll-Erkennung
    window.addEventListener('scroll', function() {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      
      // Prüfe, ob der Nutzer manuell nach oben scrollt
      if (scrollTop < lastScrollTop) {
        userHasScrolled = true;
      }
      
      // Wenn der Nutzer bis fast zum Ende der Seite gescrollt hat, aktiviere Auto-Scroll wieder
      const scrollHeight = document.documentElement.scrollHeight;
      const clientHeight = document.documentElement.clientHeight;
      
      if (scrollTop + clientHeight >= scrollHeight - 100) {
        userHasScrolled = false;
      }
      
      lastScrollTop = scrollTop;
    }, false);
    
    // Funktion, die entscheidet, ob auto-gescrollt werden soll
    function shouldAutoScroll() {
      return !userHasScrolled;
    }

    // Hinzufügen der neuen Funktion zum Behandeln der Benutzerauswahl
    function handleUserChoice(choice) {
      if (choice === 'analyze') {
        console.log("Analysieren ausgewählt, starte Prozess...");
        
        // Der Analyse-Ergebnis-Container wird nicht mehr angezeigt, 
        // wir verwenden jetzt nur noch den Chat-Container
        
        // Zeige den Analysedetails-Container an
        const detailsContainer = document.getElementById('analysis-details-container');
        if (detailsContainer) {
          detailsContainer.style.display = 'block';
        }
        
        // ChatGPT-Analyse direkt starten
        setTimeout(() => {
          deepAnalyzeData();
        }, 100);
        
        // Buttons werden jetzt in der deepAnalyzeData-Funktion hinzugefügt,
        // nachdem die ChatGPT-Antwort angezeigt wurde
      } else {
        // Für Grafik-Erstellung
        setTimeout(() => {
          const message = 'Super! Lass uns eine Datawrapper-Grafik erstellen. Welche Art von Grafik schwebt dir vor?';
          addMessageToChat(message, true);
          
          // Zeige das freie Texteingabefeld an
          document.getElementById('free-text-container').style.display = 'flex';
          
          // Füge die Grafiktyp-Buttons hinzu
          const buttonContainer = document.createElement('div');
          buttonContainer.style.width = '60%';
          buttonContainer.style.marginTop = '20px';
          buttonContainer.style.display = 'grid';
          buttonContainer.style.gridTemplateColumns = 'repeat(4, 1fr)';
          buttonContainer.style.gap = '10px';
          
          const buttonStyles = `
            padding: 12px 18px;
            background-color: #f0f2f5;
            color: #333;
            border: none;
            border-radius: 20px;
            font-family: 'DINNextLTPro', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
          `;
          
          const buttonTypes = [
            { name: 'Locator', icon: 'map-pin' },
            { name: 'Balken', icon: 'bar-chart-2' },
            { name: 'Säulen', icon: 'bar-chart' },
            { name: 'Torte', icon: 'pie-chart' }
          ];
          
          buttonTypes.forEach(type => {
            const button = document.createElement('button');
            button.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                ${getIconPath(type.icon)}
              </svg>
              ${type.name}
            `;
            button.style.cssText = buttonStyles;
            button.onclick = () => handleChartTypeSelection(type.name);
            buttonContainer.appendChild(button);
          });
          
          // Füge den Button-Container nach dem Texteingabefeld ein
          const textInputContainer = document.getElementById('free-text-container');
          textInputContainer.parentNode.insertBefore(buttonContainer, textInputContainer.nextSibling);
          
          // Scroll zum Eingabefeld
          scrollToInputField();
        }, 700);
      }
      
      // Speichere die Auswahl für spätere Verwendung
      if (!document.getElementById('user-choice')) {
        const hiddenField = document.createElement('input');
        hiddenField.type = 'hidden';
        hiddenField.id = 'user-choice';
        document.body.appendChild(hiddenField);
      }
      document.getElementById('user-choice').value = choice;
    }

    // Funktion zum Starten der Tiefenanalyse
    async function deepAnalyzeData() {
      try {
        // Zeige Spinner
        document.getElementById('spinner').style.display = 'flex';
        
        // Der Prompt für ChatGPT (nicht sichtbar für den Nutzer)
        const prompt = "Du bist ein Senior Datenanalyst und Datenjournalist. Du möchtest aus dem vorliegenden Datensatz einen journalistischen Artikel machen. Dafür benötige ich zunächst von dir eine aussagekräftige Analyse des Datensatzes.";
        
        // Hole die chartdata_id aus dem versteckten Feld
        const chartDataId = document.getElementById('chartdata-id')?.value;
        
        if (!chartDataId) {
          throw new Error("Keine Datensatz-ID gefunden. Bitte lade den Datensatz erneut hoch.");
        }
        
        console.log("Sende Anfrage an ChatGPT API mit dem Prompt und der Datensatz-ID:", {
          prompt: prompt,
          chartDataId: chartDataId
        });
        
        // Sende Anfrage an ChatGPT
        const response = await fetch('/analyze-data/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            message: prompt,
            chartdata_id: chartDataId,
            include_data: true  // Explizit anfordern, dass der Datensatz mitgeschickt wird
          })
        });

        const data = await response.json();
        
        console.log("Antwort von der ChatGPT API:", data);
        
        if (data.error) {
          throw new Error(data.error);
        }

        // Vermeide die doppelte Anzeige, indem wir den alten Container ausblenden
        const analysisResultContainer = document.getElementById('analysis-result-container');
        if (analysisResultContainer) {
          analysisResultContainer.style.display = 'none';
        }
        
        // Füge die ChatGPT-Antwort zum Chat hinzu
        addMessageToChat(data.response, true);
        
        // Zeige das freie Texteingabefeld an
        document.getElementById('free-text-container').style.display = 'flex';
        
        // Füge die Grafiktyp-Buttons hinzu
        const buttonContainer = document.createElement('div');
        buttonContainer.style.width = '60%';
        buttonContainer.style.marginTop = '20px';
        buttonContainer.style.display = 'grid';
        buttonContainer.style.gridTemplateColumns = 'repeat(4, 1fr)';
        buttonContainer.style.gap = '10px';
        
        const buttonStyles = `
          padding: 12px 18px;
          background-color: #f0f2f5;
          color: #333;
          border: none;
          border-radius: 20px;
          font-family: 'DINNextLTPro', sans-serif;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.2s ease;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
        `;
        
        const buttonTypes = [
          { name: 'Locator', icon: 'map-pin' },
          { name: 'Balken', icon: 'bar-chart-2' },
          { name: 'Säulen', icon: 'bar-chart' },
          { name: 'Torte', icon: 'pie-chart' }
        ];
        
        buttonTypes.forEach(type => {
          const button = document.createElement('button');
          button.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              ${getIconPath(type.icon)}
            </svg>
            ${type.name}
          `;
          button.style.cssText = buttonStyles;
          button.onclick = () => handleChartTypeSelection(type.name);
          buttonContainer.appendChild(button);
        });
        
        // Füge den Button-Container nach dem Texteingabefeld ein
        const textInputContainer = document.getElementById('free-text-container');
        textInputContainer.parentNode.insertBefore(buttonContainer, textInputContainer.nextSibling);
        
        // Scroll zum Eingabefeld
        scrollToInputField();

      } catch (error) {
        console.error("Fehler bei der API-Anfrage:", error);
        alert('Fehler bei der Kommunikation mit ChatGPT: ' + error.message);
      } finally {
        // Verstecke Spinner
        document.getElementById('spinner').style.display = 'none';
      }
    }

    // Funktion zum Senden einer Nachricht an ChatGPT
    async function sendToChatGPT() {
      const userInput = document.getElementById('user-input');
      const userMessage = userInput.value.trim();
      
      if (!userMessage) return;
      
      // Füge die Nutzernachricht zum Chat hinzu
      addMessageToChat(userMessage, false);
      
      // Leere das Eingabefeld
      userInput.value = '';
      
      try {
        // Zeige Spinner
        document.getElementById('spinner').style.display = 'flex';
        
        // Hier würde der API-Call an ChatGPT erfolgen
        // Für jetzt nur ein Platzhalter
        const response = await fetch('/analyze-data/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ message: userMessage })
        });

        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error);
        }

        // Füge die ChatGPT-Antwort zum Chat hinzu
        addMessageToChat(data.response, true);
        
        // Scroll zum Eingabefeld nach der Antwort
        scrollToInputField();

      } catch (error) {
        alert('Fehler bei der Kommunikation mit ChatGPT: ' + error.message);
      } finally {
        // Verstecke Spinner
        document.getElementById('spinner').style.display = 'none';
      }
    }

    // Funktion zum Scrollen zum Eingabefeld
    function scrollToInputField() {
      // Stellt sicher, dass das Eingabefeld und sein Container sichtbar sind
      const inputContainer = document.getElementById('free-text-container');
      const userInput = document.getElementById('user-input');
      
      if (inputContainer.style.display === 'flex') {
        // Verzögerung, um sicherzustellen, dass das DOM aktualisiert wurde
        setTimeout(() => {
          // Scroll zum Eingabefeld
          userInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          // Fokus auf das Eingabefeld setzen für sofortige Texteingabe
          userInput.focus();
          
          // Setze userHasScrolled zurück, damit auto-scrolling weiterhin funktioniert
          userHasScrolled = false;
        }, 200);
      }
    }

    // Modifiziere die existierende handlePastedData Funktion
    async function handlePastedData() {
      const textContent = document.getElementById('data-input').value;
      if (!textContent.trim()) return;

      try {
        document.getElementById('spinner').style.display = 'flex';
        
        const formData = new FormData();
        const blob = new Blob([textContent], { type: 'text/plain' });
        formData.append('file', blob, 'pasted_data.csv');
        
        console.log("Starte Datenverarbeitung ohne OpenAI API...");
        
        const response = await fetch('/analyze-data/', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();
        
        console.log("Datenverarbeitung abgeschlossen:", data);
        
        if (data.error) {
          throw new Error(data.error);
        }

        // Zeige Analyse-Container
        const analysisContainer = document.getElementById('analysis-container');
        analysisContainer.style.display = 'block';
        
        // Speichere die Analyse-Daten global für späteren Zugriff
        window.analysisData = data;
        
        // Verarbeite Warnungen
        processWarnings(data.warnings);
        
        // Verarbeite Metadaten
        processMetadata(data.metadata);
        
        // Zeige Datenvorschau - Dies verwendet nur den lokalen JavaScript-Code
        showDataPreview(textContent);

        // Speichere die chartdata_id für spätere Verwendung
        if (data.chartdata_id) {
          // Speichere die ID in einem versteckten Feld
          if (!document.getElementById('chartdata-id')) {
            const hiddenField = document.createElement('input');
            hiddenField.type = 'hidden';
            hiddenField.id = 'chartdata-id';
            document.body.appendChild(hiddenField);
          }
          document.getElementById('chartdata-id').value = data.chartdata_id;
          console.log('ChartData ID gespeichert:', data.chartdata_id);
        }

        // Scrolle zum Analyse-Container mit Animation
        scrollToAnalysisContainer();

      } catch (error) {
        console.error("Fehler bei der ersten Datenverarbeitung:", error);
        alert('Fehler beim Analysieren der Daten: ' + error.message);
      } finally {
        document.getElementById('spinner').style.display = 'none';
      }
    }

    // Funktion zum Hochladen und Analysieren der Datei
    async function handleFileUpload(file) {
      const formData = new FormData();
      formData.append('file', file);

      try {
        // Zeige Spinner
        document.getElementById('spinner').style.display = 'flex';
        
        console.log("Starte Dateiverarbeitung ohne OpenAI API...");
        
        const response = await fetch('/analyze-data/', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();
        
        console.log("Dateiverarbeitung abgeschlossen:", data);
        
        if (data.error) {
          throw new Error(data.error);
        }

        // Zeige Analyse-Container
        const analysisContainer = document.getElementById('analysis-container');
        analysisContainer.style.display = 'block';
        
        // Speichere die Analyse-Daten global für späteren Zugriff
        window.analysisData = data;
        
        // Verarbeite Warnungen
        processWarnings(data.warnings);
        
        // Verarbeite Metadaten
        processMetadata(data.metadata);
        
        // Lese die Datei für die Vorschau - Dies passiert lokal im Browser
        const reader = new FileReader();
        reader.onload = function(e) {
          showDataPreview(e.target.result);
        };
        reader.readAsText(file);
        
        // Speichere die chartdata_id für spätere Verwendung
        if (data.chartdata_id) {
          // Speichere die ID in einem versteckten Feld
          if (!document.getElementById('chartdata-id')) {
            const hiddenField = document.createElement('input');
            hiddenField.type = 'hidden';
            hiddenField.id = 'chartdata-id';
            document.body.appendChild(hiddenField);
          }
          document.getElementById('chartdata-id').value = data.chartdata_id;
          console.log('ChartData ID gespeichert:', data.chartdata_id);
        }

        // Scrolle zum Analyse-Container mit Animation
        scrollToAnalysisContainer();

      } catch (error) {
        console.error("Fehler bei der Dateiverarbeitung:", error);
        alert('Fehler beim Analysieren der Datei: ' + error.message);
      } finally {
        document.getElementById('spinner').style.display = 'none';
      }
    }

    // Hilfsfunktion zum Verarbeiten der Warnungen
    function processWarnings(warnings = []) {
      const infoWarningsContainer = document.getElementById('info-warnings');
      const importantWarningsContainer = document.getElementById('important-warnings');
      const infoContent = document.getElementById('info-warnings-content');
      const importantContent = document.getElementById('important-warnings-content');
      
      infoContent.innerHTML = '';
      importantContent.innerHTML = '';
      infoWarningsContainer.style.display = 'none';
      importantWarningsContainer.style.display = 'none';
      
      warnings.forEach(warning => {
        if (warning.type === 'info') {
          infoContent.innerHTML += `<p>${warning.message}</p>`;
          infoWarningsContainer.style.display = 'block';
        } else if (warning.type === 'warning') {
          importantContent.innerHTML += `<p>${warning.message}</p>`;
          importantWarningsContainer.style.display = 'block';
        }
      });
    }

    // Hilfsfunktion zum Verarbeiten der Metadaten
    function processMetadata(metadata = {}) {
      const headerMetadataContainer = document.getElementById('header-metadata');
      const footerMetadataContainer = document.getElementById('footer-metadata');
      const headerContent = document.getElementById('header-metadata-content');
      const footerContent = document.getElementById('footer-metadata-content');
      
      if (metadata.header && metadata.header.length > 0) {
        headerContent.textContent = metadata.header.join('\n');
        headerMetadataContainer.style.display = 'block';
      } else {
        headerMetadataContainer.style.display = 'none';
      }
      
      if (metadata.footer && metadata.footer.length > 0) {
        footerContent.textContent = metadata.footer.join('\n');
        footerMetadataContainer.style.display = 'block';
      } else {
        footerMetadataContainer.style.display = 'none';
      }
    }

    // Hilfsfunktion zum Anzeigen der Datenvorschau
    function showDataPreview(content) {
      // Erstelle den Container, falls er nicht existiert
      let previewContainer = document.getElementById('preview-content');
      if (!previewContainer) {
        previewContainer = document.createElement('div');
        previewContainer.id = 'preview-content';
        previewContainer.style.marginTop = '20px';
        previewContainer.style.overflowX = 'auto';
        previewContainer.style.fontFamily = 'monospace';
        previewContainer.style.fontSize = '14px';
        
        // Füge den Container nach der Erfolgsmeldung ein
        const successMessage = document.getElementById('success-message');
        if (successMessage && successMessage.parentElement) {
          successMessage.parentElement.appendChild(previewContainer);
        }
      }
      
      // Beschränke die Vorschau auf 10 Zeilen
      const lines = content.split('\n');
      let preview = '';
      
      // Erkenne das Trennzeichen
      let delimiter = ',';
      if (lines.length > 0) {
        const firstLine = lines[0];
        // Prüfe verschiedene Trennzeichen
        if (firstLine.includes('\t')) {
          delimiter = '\t';
        } else if (firstLine.includes(';')) {
          delimiter = ';';
        }
      }
      
      // Erstelle eine Tabelle
      preview += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
      
      // Verarbeite die ersten 10 Zeilen
      const previewLines = Math.min(10, lines.length);
      let maxColumns = 0;
      
      // Erste Durchlauf: Finde die maximale Anzahl von Spalten
      for (let i = 0; i < previewLines; i++) {
        const cells = lines[i].split(delimiter).map(cell => cell.trim());
        maxColumns = Math.max(maxColumns, cells.length);
      }
      
      // Zweiter Durchlauf: Erstelle die Tabelle
      for (let i = 0; i < previewLines; i++) {
        const cells = lines[i].split(delimiter).map(cell => cell.trim());
        preview += '<tr>';
        
        // Fülle die Zeile mit Zellen
        for (let j = 0; j < maxColumns; j++) {
          const cellContent = cells[j] || ''; // Leere Zelle wenn keine Daten
          preview += `<td style="padding: 8px; border: 1px solid #ddd; font-family: monospace; font-size: 14px;">${cellContent}</td>`;
        }
        
        preview += '</tr>';
      }
      
      preview += '</table>';
      
      // Füge Information über weitere Zeilen hinzu
      if (lines.length > 10) {
        preview += `<div style="padding: 5px 0; color: #888; margin-top: 10px;">... und ${lines.length - 10} weitere Zeilen</div>`;
      }
      
      previewContainer.innerHTML = preview;
    }

    // Füge diese Hilfsfunktion am Ende des Scripts hinzu
    function getIconPath(icon) {
      const icons = {
        'map-pin': '<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle>',
        'bar-chart-2': '<line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line>',
        'bar-chart': '<line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line>',
        'pie-chart': '<path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 1 1 12 2"></path><path d="M22 12h-10"></path><path d="M22 12a10 10 0 0 1-10 10"></path>'
      };
      return icons[icon] || '';
    }

    function handleChartTypeSelection(type) {
      console.log('Ausgewählter Grafiktyp:', type);
      
      // Erstelle die Abfragemaske für die Grafik
      if (type === 'Balken' || type === 'Säulen' || type === 'Torte') {
        // Verstecke Textfeld und Buttons
        document.getElementById('free-text-container').style.display = 'none';
        
        // Entferne vorhandene Abfragemasken, falls vorhanden
        const existingForm = document.getElementById('chart-form-container');
        if (existingForm) {
          existingForm.remove();
        }
        
        // Erstelle den Container für das Formular
        const formContainer = document.createElement('div');
        formContainer.id = 'chart-form-container';
        formContainer.style.width = '60%';
        formContainer.style.background = '#f5f5f5';
        formContainer.style.padding = '25px';
        formContainer.style.borderRadius = '8px';
        formContainer.style.marginTop = '20px';
        formContainer.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
        
        // Füge Header hinzu
        const formHeader = document.createElement('h3');
        formHeader.textContent = `${type}-Grafik erstellen`;
        formHeader.style.fontFamily = "'DINNextLTPro', sans-serif";
        formHeader.style.fontSize = '1.3em';
        formHeader.style.color = '#333';
        formHeader.style.marginBottom = '20px';
        formContainer.appendChild(formHeader);
        
        // Felder für das Formular
        const fields = [
          { id: 'title', label: 'Überschrift', type: 'text', placeholder: 'Hauptüberschrift der Grafik' },
          { id: 'subtitle', label: 'Unterzeile', type: 'text', placeholder: 'Erklärende Unterzeile' },
          { id: 'source', label: 'Datenquelle', type: 'text', placeholder: 'Quelle der Daten' },
          { id: 'source_url', label: 'Link zur Datenquelle', type: 'url', placeholder: 'https://...' },
          { id: 'author', label: 'Autor', type: 'text', placeholder: 'Dein Name' },
          { id: 'tags', label: 'Schlagworte', type: 'text', placeholder: 'Komma-getrennte Schlagworte' }
        ];
        
        // Erstelle die Formularfelder
        fields.forEach(field => {
          const fieldGroup = document.createElement('div');
          fieldGroup.style.marginBottom = '15px';
          
          const label = document.createElement('label');
          label.setAttribute('for', field.id);
          label.textContent = field.label;
          label.style.display = 'block';
          label.style.marginBottom = '5px';
          label.style.fontFamily = "'DINNextLTPro', sans-serif";
          label.style.fontSize = '0.9em';
          label.style.color = '#555';
          
          const input = document.createElement('input');
          input.type = field.type;
          input.id = field.id;
          input.name = field.id;
          input.placeholder = field.placeholder;
          input.style.width = '100%';
          input.style.padding = '10px';
          input.style.border = '1px solid #ddd';
          input.style.borderRadius = '4px';
          input.style.fontSize = '1em';
          input.style.boxSizing = 'border-box';
          
          fieldGroup.appendChild(label);
          fieldGroup.appendChild(input);
          formContainer.appendChild(fieldGroup);
        });
        
        // Erstelle die Buttons für das Formular
        const buttonsGroup = document.createElement('div');
        buttonsGroup.style.display = 'flex';
        buttonsGroup.style.justifyContent = 'space-between';
        buttonsGroup.style.marginTop = '25px';
        
        // Zurück-Button
        const backButton = document.createElement('button');
        backButton.textContent = 'Zurück';
        backButton.style.padding = '10px 20px';
        backButton.style.backgroundColor = '#f0f2f5';
        backButton.style.color = '#333';
        backButton.style.border = 'none';
        backButton.style.borderRadius = '4px';
        backButton.style.fontFamily = "'DINNextLTPro', sans-serif";
        backButton.style.cursor = 'pointer';
        backButton.onclick = () => {
          formContainer.remove();
          document.getElementById('free-text-container').style.display = 'flex';
        };
        
        // Weiter-Button
        const submitButton = document.createElement('button');
        submitButton.textContent = 'Grafik erstellen';
        submitButton.style.padding = '10px 20px';
        submitButton.style.backgroundColor = '#4f80ff';
        submitButton.style.color = 'white';
        submitButton.style.border = 'none';
        submitButton.style.borderRadius = '4px';
        submitButton.style.fontFamily = "'DINNextLTPro', sans-serif";
        submitButton.style.cursor = 'pointer';
        submitButton.onclick = () => createChart(type);
        
        buttonsGroup.appendChild(backButton);
        buttonsGroup.appendChild(submitButton);
        formContainer.appendChild(buttonsGroup);
        
        // Füge das Formular nach dem Chat-Container ein
        const chatContainer = document.getElementById('chat-container');
        chatContainer.parentNode.insertBefore(formContainer, chatContainer.nextSibling);
        
        // Scrolle zum Formular
        setTimeout(() => {
          formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
      } else if (type === 'Locator') {
        // Hier später die spezielle Logik für Locator-Maps einfügen
        alert('Locator-Karten werden in einem zukünftigen Update unterstützt!');
      }
    }
    
    // Funktion zum Erstellen der Grafik basierend auf den Formulardaten
    function createChart(type) {
      // Sammle die Daten aus dem Formular
      const chartData = {
        title: document.getElementById('title').value,
        subtitle: document.getElementById('subtitle').value,
        source: document.getElementById('source').value,
        source_url: document.getElementById('source_url').value,
        author: document.getElementById('author').value,
        tags: document.getElementById('tags').value,
        type: type,
        chartdata_id: document.getElementById('chartdata-id')?.value
      };
      
      console.log('Grafik wird erstellt mit den Daten:', chartData);
      
      // Zeige Spinner während der API-Anfrage
      document.getElementById('spinner').style.display = 'flex';
      
      // Verstecke das Formular
      const formContainer = document.getElementById('chart-form-container');
      if (formContainer) {
        formContainer.style.display = 'none';
      }
      
      // Füge eine Nachricht zum Chat hinzu
      addMessageToChat(`Grafik vom Typ "${type}" wird erstellt...`, true);
      
      // Hole die ChartData-ID, um die Rohdaten zu erhalten
      const chartDataId = document.getElementById('chartdata-id')?.value;
      
      if (!chartDataId) {
        addMessageToChat("Fehler: Keine Datensatz-ID gefunden. Bitte lade den Datensatz erneut hoch.", true);
        document.getElementById('spinner').style.display = 'none';
        return;
      }
      
      // Bestimme den Datawrapper-Grafiktyp basierend auf unserer Auswahl
      let dwChartType = '';
      switch (type) {
        case 'Balken':
          dwChartType = 'd3-bars';
          break;
        case 'Säulen':
          dwChartType = 'd3-columns';
          break;
        case 'Torte':
          dwChartType = 'd3-pie';
          break;
        default:
          dwChartType = 'd3-bars';
      }
      
      // Sende Anfrage an den Server, um die Grafik über die Datawrapper-API zu erstellen
      fetch('/create-datawrapper-chart/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          chart_type: dwChartType,
          title: chartData.title,
          subtitle: chartData.subtitle,
          source_name: chartData.source,
          source_url: chartData.source_url,
          byline: chartData.author,
          chartdata_id: chartDataId,
          tags: chartData.tags
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Netzwerkantwort war nicht in Ordnung');
        }
        return response.json();
      })
      .then(data => {
        console.log('Erfolgreich Grafik erstellt:', data);
        document.getElementById('spinner').style.display = 'none';
        
        // Zeige Erfolgsmeldung mit Link zur Grafik
        const successMessage = `
          Grafik "${chartData.title}" wurde erfolgreich erstellt!
          
          Grafik-ID: ${data.chart_id}
          
          Du kannst die Grafik hier anzeigen und bearbeiten:
          https://app.datawrapper.de/chart/${data.chart_id}/visualize
        `;
        
        addMessageToChat(successMessage, true);
        
        // Zeige die Grafik direkt mit dem Einbindungscode an
        showEmbeddedChart(data.chart_id, chartData.title);
        
        // Füge Buttons für weitere Aktionen hinzu
        addChartActionButtons(data.chart_id);
      })
      .catch(error => {
        console.error('Fehler beim Erstellen der Grafik:', error);
        document.getElementById('spinner').style.display = 'none';
        addMessageToChat(`Fehler beim Erstellen der Grafik: ${error.message}`, true);
      });
    }
    
    // Funktion zum Anzeigen der eingebetteten Grafik
    function showEmbeddedChart(chartId, title) {
      // Erstelle den Container für die Grafik
      const chartContainer = document.createElement('div');
      chartContainer.className = 'message-container';
      chartContainer.style.display = 'flex';
      chartContainer.style.justifyContent = 'flex-start';
      chartContainer.style.width = '100%';
      chartContainer.style.marginTop = '30px';
      
      // Erstelle den Inhalt des Containers
      const chartContent = document.createElement('div');
      chartContent.className = 'message gpt-message';
      chartContent.style.width = '100%';
      chartContent.style.padding = '20px';
      chartContent.style.borderRadius = '8px';
      chartContent.style.backgroundColor = 'white';
      chartContent.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
      
      // Erstelle eine Überschrift für die Grafik
      const chartTitle = document.createElement('h3');
      chartTitle.textContent = title || 'Deine erstellte Grafik';
      chartTitle.style.fontFamily = "'DINNextLTPro', sans-serif";
      chartTitle.style.fontSize = '1.2em';
      chartTitle.style.color = '#333';
      chartTitle.style.marginBottom = '15px';
      
      // Füge die Überschrift zum Container hinzu
      chartContent.appendChild(chartTitle);
      
      // Erstelle ein Div für die Grafik
      const chartDiv = document.createElement('div');
      chartDiv.id = 'chart-' + chartId;
      chartDiv.style.width = '600px';
      chartDiv.style.height = '400px';
      chartDiv.style.border = '1px solid #eee';
      chartDiv.style.borderRadius = '4px';
      chartDiv.style.overflow = 'hidden';
      chartDiv.style.maxWidth = '100%';
      chartDiv.style.margin = '0 auto';
      
      // Erstelle das Script-Element
      const scriptElem = document.createElement('script');
      scriptElem.src = 'https://static.rndtech.de/share/rnd/datenrecherche/script/dw_chart_min.js';
      scriptElem.defer = true;
      
      // Erstelle das dw-chart Custom Element
      const dwChart = document.createElement('dw-chart');
      dwChart.setAttribute('chart-id', chartId);
      
      // Füge die Elemente zum Div hinzu
      chartDiv.appendChild(scriptElem);
      chartDiv.appendChild(dwChart);
      
      // Füge das Div zum Container hinzu
      chartContent.appendChild(chartDiv);
      
      // Füge alles zum Haupt-Container hinzu
      chartContainer.appendChild(chartContent);
      
      // Füge den Container zum Chat-Container hinzu
      const chatContainer = document.getElementById('chat-container');
      chatContainer.appendChild(chartContainer);
      
      // Stelle sicher, dass das Script global geladen ist
      ensureDwChartScriptLoaded();
      
      // Scrolle zur Grafik nach kurzer Verzögerung
      setTimeout(() => {
        chartContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 200);
    }
    
    // Funktion, um sicherzustellen, dass das Script für dw-chart geladen ist
    function ensureDwChartScriptLoaded() {
      if (!document.querySelector('script[src="https://static.rndtech.de/share/rnd/datenrecherche/script/dw_chart_min.js"]')) {
        const script = document.createElement('script');
        script.src = 'https://static.rndtech.de/share/rnd/datenrecherche/script/dw_chart_min.js';
        script.defer = true;
        document.head.appendChild(script);
      }
    }

    // Funktion zum Hinzufügen von Aktionsbuttons für die erstellte Grafik
    function addChartActionButtons(chartId) {
      // Erstelle Container für die Optionen
      const optionsContainer = document.createElement('div');
      optionsContainer.className = 'message-container';
      optionsContainer.style.display = 'flex';
      optionsContainer.style.justifyContent = 'flex-end';
      optionsContainer.style.width = '100%';
      optionsContainer.style.marginTop = '20px';
      
      // Erstelle Button-Container
      const buttonsContainer = document.createElement('div');
      buttonsContainer.style.width = '60%';
      buttonsContainer.style.background = '#e3f2fd';
      buttonsContainer.style.padding = '20px';
      buttonsContainer.style.borderRadius = '8px';
      buttonsContainer.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
      
      // Erstelle Buttons
      const buttonStyles = {
        base: `
          padding: 12px 18px;
          border: none;
          border-radius: 20px;
          font-family: 'DINNextLTPro', sans-serif;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.2s ease;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
          margin-bottom: 10px;
          width: 100%;
        `,
        primary: `
          background-color: #4f80ff;
          color: white;
        `,
        secondary: `
          background-color: #f0f2f5;
          color: #333;
        `
      };
      
      // Button 1: Grafik bearbeiten
      const editButton = document.createElement('button');
      editButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 20h9"></path>
          <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
        </svg>
        Grafik in Datawrapper bearbeiten
      `;
      editButton.style.cssText = buttonStyles.base + buttonStyles.primary;
      editButton.onclick = () => {
        window.open(`https://app.datawrapper.de/chart/${chartId}/visualize`, '_blank');
      };
      
      // Button 2: Grafik mit KI bearbeiten
      const aiEditButton = document.createElement('button');
      aiEditButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 2a10 10 0 0 0-5 18.66a1 1 0 0 0 1.72 0A10 10 0 0 0 12 2z"></path>
          <path d="M12 6a6 6 0 0 0-6 6c0 3.31 2.69 6 6 6s6-2.69 6-6a6 6 0 0 0-6-6z"></path>
        </svg>
        Grafik mit KI bearbeiten
      `;
      aiEditButton.style.cssText = buttonStyles.base + buttonStyles.primary;
      aiEditButton.onclick = () => showAIEditForm(chartId);
      
      // Button 3: Neu starten
      const newChartButton = document.createElement('button');
      newChartButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 2v6h6"></path>
          <path d="M3 13a9 9 0 1 0 3-7.7L3 8"></path>
        </svg>
        Neuen Datensatz hochladen
      `;
      newChartButton.style.cssText = buttonStyles.base + buttonStyles.secondary;
      newChartButton.onclick = () => window.location.reload();
      
      // Füge Buttons zum Container hinzu
      buttonsContainer.appendChild(editButton);
      buttonsContainer.appendChild(aiEditButton);
      buttonsContainer.appendChild(newChartButton);
      
      // Füge Button-Container zum Options-Container hinzu
      optionsContainer.appendChild(buttonsContainer);
      
      // Füge Options-Container zum Chat-Container hinzu
      const chatContainer = document.getElementById('chat-container');
      chatContainer.appendChild(optionsContainer);
      
      // Scrolle zu den Optionen
      setTimeout(() => {
        optionsContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 100);
    }
    
    // Funktion zum Anzeigen des KI-Bearbeitungsformulars
    function showAIEditForm(chartId) {
      // Erstelle Container für das Formular
      const formContainer = document.createElement('div');
      formContainer.style.width = '60%';
      formContainer.style.background = '#f5f5f5';
      formContainer.style.padding = '25px';
      formContainer.style.borderRadius = '8px';
      formContainer.style.marginTop = '20px';
      formContainer.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
      
      // Füge Header hinzu
      const formHeader = document.createElement('h3');
      formHeader.textContent = 'Grafik mit KI bearbeiten';
      formHeader.style.fontFamily = "'DINNextLTPro', sans-serif";
      formHeader.style.fontSize = '1.3em';
      formHeader.style.color = '#333';
      formHeader.style.marginBottom = '20px';
      formContainer.appendChild(formHeader);
      
      // Erstelle Textarea für Anweisungen
      const textarea = document.createElement('textarea');
      textarea.id = 'ai-edit-instructions';
      textarea.placeholder = 'Beschreibe hier, wie die Grafik angepasst werden soll...';
      textarea.style.width = '100%';
      textarea.style.minHeight = '150px';
      textarea.style.padding = '15px';
      textarea.style.border = '1px solid #ddd';
      textarea.style.borderRadius = '4px';
      textarea.style.fontSize = '1em';
      textarea.style.marginBottom = '20px';
      textarea.style.boxSizing = 'border-box';
      formContainer.appendChild(textarea);
      
      // Erstelle Button-Container
      const buttonContainer = document.createElement('div');
      buttonContainer.style.display = 'flex';
      buttonContainer.style.justifyContent = 'space-between';
      buttonContainer.style.gap = '10px';
      
      // Abbrechen-Button
      const cancelButton = document.createElement('button');
      cancelButton.textContent = 'Abbrechen';
      cancelButton.style.padding = '10px 20px';
      cancelButton.style.backgroundColor = '#f0f2f5';
      cancelButton.style.color = '#333';
      cancelButton.style.border = 'none';
      cancelButton.style.borderRadius = '4px';
      cancelButton.style.fontFamily = "'DINNextLTPro', sans-serif";
      cancelButton.style.cursor = 'pointer';
      cancelButton.onclick = () => formContainer.remove();
      
      // Senden-Button
      const submitButton = document.createElement('button');
      submitButton.textContent = 'An KI senden';
      submitButton.style.padding = '10px 20px';
      submitButton.style.backgroundColor = '#4f80ff';
      submitButton.style.color = 'white';
      submitButton.style.border = 'none';
      submitButton.style.borderRadius = '4px';
      submitButton.style.fontFamily = "'DINNextLTPro', sans-serif";
      submitButton.style.cursor = 'pointer';
      submitButton.onclick = () => sendToAI(chartId, textarea.value);
      
      buttonContainer.appendChild(cancelButton);
      buttonContainer.appendChild(submitButton);
      formContainer.appendChild(buttonContainer);
      
      // Füge das Formular nach den Aktionsbuttons ein
      const optionsContainer = document.querySelector('.message-container:last-child');
      optionsContainer.parentNode.insertBefore(formContainer, optionsContainer.nextSibling);
      
      // Scrolle zum Formular
      setTimeout(() => {
        formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
    }
    
    // Funktion zum Senden der Anweisungen an die KI
    async function sendToAI(chartId, instructions) {
      if (!instructions.trim()) {
        alert('Bitte gib Anweisungen für die KI ein.');
        return;
      }
      
      try {
        document.getElementById('spinner').style.display = 'flex';
        
        // Erstelle den Prompt für die KI
        const prompt = `Ich habe eine Datawrapper-Grafik mit der ID ${chartId}. Bitte analysiere die Grafik und gib mir Anweisungen, wie ich sie gemäß folgender Vorgaben anpassen kann:\n\n${instructions}`;
        
        // Sende Anfrage an ChatGPT
        const response = await fetch('/analyze-data/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            message: prompt,
            chart_id: chartId
          })
        });
        
        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error);
        }
        
        // Zeige die KI-Antwort im Chat
        addMessageToChat(data.response, true);
        
        // Entferne das Formular
        const formContainer = document.getElementById('ai-edit-instructions').closest('div');
        formContainer.remove();
        
      } catch (error) {
        console.error('Fehler bei der KI-Anfrage:', error);
        alert('Fehler bei der Kommunikation mit der KI: ' + error.message);
      } finally {
        document.getElementById('spinner').style.display = 'none';
      }
    }
  </script>
{% endblock %} 