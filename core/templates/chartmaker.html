{% extends 'base.html' %}

{% block title %}Chartmaker{% endblock %}

{% block content %}
  {% include 'partials/header.html' %}
  
  <style>
    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #4f80ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>

  <!-- Spinner Overlay -->
  <div class="spinner-overlay" id="spinner">
    <div class="spinner"></div>
  </div>
  
  <div style="max-width: 1200px; margin: 40px auto; padding: 0 20px;">
    <h1 style="font-family: 'DINNextLTPro', sans-serif; font-size: 2.5em; color: #333;">Chartmaker</h1>
    
    <div style="margin-top: 40px;">
      <h2 style="font-family: 'DINNextLTPro', sans-serif; font-size: 1.8em; color: #333; margin-bottom: 20px;">
        Daten einfügen
      </h2>
      
      <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: center;">
        <!-- Copy-Paste Bereich -->
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative;">
          <h3 style="font-family: 'DINNextLTPro', sans-serif; font-size: 1.2em; color: #666; margin-bottom: 15px;">
            Daten kopieren & einfügen
          </h3>
          <textarea 
            id="data-input"
            placeholder="Füge hier deine Daten ein (z.B. aus Excel oder Google Sheets)..."
            style="
              width: 100%;
              min-height: 200px;
              padding: 15px;
              border: 1px solid #ddd;
              border-radius: 4px;
              font-family: monospace;
              font-size: 14px;
              resize: vertical;
              box-sizing: border-box;
            "
          ></textarea>
          <button 
            id="submit-button" 
            style="
              position: absolute;
              bottom: 30px;
              right: 30px;
              padding: 10px 20px;
              background-color: #4f80ff;
              color: white;
              border: none;
              border-radius: 4px;
              font-family: 'DINNextLTPro', sans-serif;
              cursor: pointer;
              display: none;
              transition: all 0.3s ease;
            "
            onclick="handlePastedData()"
          >
            abschicken
          </button>
        </div>

        <!-- ODER Trenner -->
        <div style="
          font-family: 'DINNextLTPro', sans-serif;
          font-size: 1.2em;
          color: #666;
          text-align: center;
          position: relative;
          padding: 0 20px;
        ">
          <div style="
            background: #f2f2f2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
          ">
            oder
          </div>
        </div>
        
        <!-- Upload Bereich -->
        <div style="
          background: white;
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          border: 2px dashed #ddd;
        ">
          <h3 style="font-family: 'DINNextLTPro', sans-serif; font-size: 1.2em; color: #666; margin-bottom: 15px; text-align: center;">
            Datei hochladen
          </h3>
          
          <div style="text-align: center;">
            <form id="upload-form" enctype="multipart/form-data">
              <input type="file" id="file-upload" name="file" accept=".csv,.xls,.xlsx" style="display: none;">
              <label for="file-upload" style="
                display: inline-block;
                padding: 12px 24px;
                background: #4f80ff;
                color: white;
                border-radius: 4px;
                cursor: pointer;
                font-family: 'DINNextLTPro', sans-serif;
                transition: all 0.3s ease;
              ">
                Datei auswählen
              </label>
              <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
                Unterstützte Formate: CSV, Excel
              </p>
            </form>
          </div>
        </div>
      </div>

      <!-- Analyse-Bereich -->
      <div id="analysis-container" style="
        margin-top: 40px;
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: none;
      ">
        <h3 style="font-family: 'DINNextLTPro', sans-serif; font-size: 1.4em; color: #333; margin-bottom: 20px;">
          Datenanalyse
        </h3>

        <!-- Chat-Container -->
        <div id="chat-container" style="
          display: flex;
          flex-direction: column;
          gap: 20px;
          margin-bottom: 30px;
        ">
          <!-- Erste Analyse von ChatGPT -->
          <div class="message-container" style="
            display: flex;
            justify-content: flex-start;
            width: 100%;
          ">
            <div class="message gpt-message" style="
              width: 60%;
              background: #f5f5f5;
              padding: 20px;
              border-radius: 8px;
              font-family: 'Source Serif Pro', serif;
              line-height: 1.6;
              color: #333;
              white-space: pre-wrap;
            ">
              <div id="analysis-content"></div>
            </div>
          </div>
        </div>

        <!-- Eingabefeld für Nutzerantwort -->
        <div class="user-input-container" style="
          display: flex;
          justify-content: flex-end;
          width: 100%;
          margin-top: 20px;
        ">
          <div style="width: 60%;">
            <textarea id="user-input" style="
              width: 100%;
              min-height: 100px;
              padding: 15px;
              border: 1px solid #ddd;
              border-radius: 8px;
              font-family: 'Source Serif Pro', serif;
              font-size: 1em;
              resize: vertical;
              margin-bottom: 10px;
            " placeholder="Stelle hier deine Frage an ChatGPT..."></textarea>
            <button onclick="sendToChatGPT()" style="
              float: right;
              padding: 10px 20px;
              background-color: #4f80ff;
              color: white;
              border: none;
              border-radius: 4px;
              font-family: 'DINNextLTPro', sans-serif;
              cursor: pointer;
              transition: all 0.3s ease;
            ">Senden</button>
          </div>
        </div>

        <!-- Warnungen -->
        <div id="warnings-container" style="margin-top: 30px;">
          <!-- Info-Warnungen -->
          <div id="info-warnings" style="
            margin-bottom: 10px;
            padding: 10px 15px;
            background: #e3f2fd;
            border-radius: 4px;
            border-left: 4px solid #2196f3;
            display: none;
          ">
            <div id="info-warnings-content" style="
              color: #1565c0;
              font-family: 'DINNextLTPro', sans-serif;
              font-size: 0.9em;
            "></div>
          </div>

          <!-- Wichtige Warnungen -->
          <div id="important-warnings" style="
            margin-bottom: 10px;
            padding: 10px 15px;
            background: #fff3e0;
            border-radius: 4px;
            border-left: 4px solid #ff9800;
            display: none;
          ">
            <div id="important-warnings-content" style="
              color: #e65100;
              font-family: 'DINNextLTPro', sans-serif;
              font-size: 0.9em;
            "></div>
          </div>
        </div>

        <!-- Metadaten-Bereich -->
        <div id="metadata-container" style="margin-top: 30px;">
          <!-- Header Metadaten -->
          <div id="header-metadata" style="
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            display: none;
          ">
            <h4 style="font-family: 'DINNextLTPro', sans-serif; font-size: 1.1em; color: #666; margin-bottom: 10px;">
              Gefundene Metadaten am Dateianfang:
            </h4>
            <div id="header-metadata-content" style="
              font-family: monospace;
              font-size: 0.9em;
              color: #666;
              white-space: pre-wrap;
            "></div>
          </div>

          <!-- Footer Metadaten -->
          <div id="footer-metadata" style="
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            display: none;
          ">
            <h4 style="font-family: 'DINNextLTPro', sans-serif; font-size: 1.1em; color: #666; margin-bottom: 10px;">
              Gefundene Fußnoten:
            </h4>
            <div id="footer-metadata-content" style="
              font-family: monospace;
              font-size: 0.9em;
              color: #666;
              white-space: pre-wrap;
            "></div>
          </div>
        </div>

        <!-- Vorschau-Bereich -->
        <div id="preview-container" style="margin-top: 30px;">
          <h4 style="font-family: 'DINNextLTPro', sans-serif; font-size: 1.2em; color: #333; margin-bottom: 15px;">
            Vorschau der Daten
          </h4>
          <div id="preview-content" style="
            overflow-x: auto;
            font-family: monospace;
            font-size: 14px;
          "></div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // Drag & Drop Funktionalität
    const dropZone = document.querySelector('input[type="file"]').parentElement.parentElement;
    
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = '#4f80ff';
      dropZone.style.backgroundColor = '#f8f9ff';
    });
    
    dropZone.addEventListener('dragleave', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = '#ddd';
      dropZone.style.backgroundColor = 'white';
    });
    
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = '#ddd';
      dropZone.style.backgroundColor = 'white';
      
      const files = e.dataTransfer.files;
      if (files.length) {
        const fileInput = document.getElementById('file-upload');
        fileInput.files = files;
        handleFileUpload(fileInput.files[0]);
      }
    });

    // Hover-Effekt für den Upload-Button
    const uploadLabel = document.querySelector('label[for="file-upload"]');
    uploadLabel.addEventListener('mouseover', () => {
      uploadLabel.style.backgroundColor = '#3a6cd9';
    });
    uploadLabel.addEventListener('mouseout', () => {
      uploadLabel.style.backgroundColor = '#4f80ff';
    });

    // Datei-Upload Handler
    document.getElementById('file-upload').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        handleFileUpload(file);
      }
    });

    // Neue Funktionen für die Textfeld-Verarbeitung
    document.getElementById('data-input').addEventListener('input', function() {
        const submitButton = document.getElementById('submit-button');
        if (this.value.trim()) {
            submitButton.style.display = 'block';
        } else {
            submitButton.style.display = 'none';
        }
    });

    // Funktion zum Hinzufügen einer neuen Nachricht zum Chat
    function addMessageToChat(content, isGPT = true) {
      const chatContainer = document.getElementById('chat-container');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message-container';
      messageDiv.style.display = 'flex';
      messageDiv.style.justifyContent = isGPT ? 'flex-start' : 'flex-end';
      messageDiv.style.width = '100%';
      
      const messageContent = document.createElement('div');
      messageContent.className = isGPT ? 'message gpt-message' : 'message user-message';
      messageContent.style.width = '60%';
      messageContent.style.padding = '20px';
      messageContent.style.borderRadius = '8px';
      messageContent.style.fontFamily = "'Source Serif Pro', serif";
      messageContent.style.lineHeight = '1.6';
      messageContent.style.color = '#333';
      messageContent.style.whiteSpace = 'pre-wrap';
      
      if (isGPT) {
        messageContent.style.background = '#f5f5f5';
      } else {
        messageContent.style.background = '#e3f2fd';
      }
      
      messageContent.textContent = content;
      messageDiv.appendChild(messageContent);
      chatContainer.appendChild(messageDiv);
    }

    // Funktion zum Senden einer Nachricht an ChatGPT
    async function sendToChatGPT() {
      const userInput = document.getElementById('user-input');
      const userMessage = userInput.value.trim();
      
      if (!userMessage) return;
      
      // Füge die Nutzernachricht zum Chat hinzu
      addMessageToChat(userMessage, false);
      
      // Leere das Eingabefeld
      userInput.value = '';
      
      try {
        // Zeige Spinner
        document.getElementById('spinner').style.display = 'flex';
        
        // Hier würde der API-Call an ChatGPT erfolgen
        // Für jetzt nur ein Platzhalter
        const response = await fetch('/analyze-data/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ message: userMessage })
        });

        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error);
        }

        // Füge die ChatGPT-Antwort zum Chat hinzu
        addMessageToChat(data.response, true);

      } catch (error) {
        alert('Fehler bei der Kommunikation mit ChatGPT: ' + error.message);
      } finally {
        // Verstecke Spinner
        document.getElementById('spinner').style.display = 'none';
      }
    }

    // Modifiziere die existierende handlePastedData Funktion
    async function handlePastedData() {
      const textContent = document.getElementById('data-input').value;
      if (!textContent.trim()) return;

      try {
        document.getElementById('spinner').style.display = 'flex';
        
        const formData = new FormData();
        const blob = new Blob([textContent], { type: 'text/plain' });
        formData.append('file', blob, 'pasted_data.csv');
        
        const response = await fetch('/analyze-data/', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error);
        }

        // Zeige Analyse-Container
        const analysisContainer = document.getElementById('analysis-container');
        analysisContainer.style.display = 'block';
        
        // Füge die erste Analyse als GPT-Nachricht hinzu
        document.getElementById('analysis-content').textContent = data.analysis;

        // Verarbeite Warnungen und Metadaten wie bisher
        // ... Rest des Codes bleibt unverändert ...

      } catch (error) {
        alert('Fehler beim Analysieren der Daten: ' + error.message);
      } finally {
        document.getElementById('spinner').style.display = 'none';
      }
    }

    // Funktion zum Hochladen und Analysieren der Datei
    async function handleFileUpload(file) {
      const formData = new FormData();
      formData.append('file', file);

      try {
        // Zeige Spinner
        document.getElementById('spinner').style.display = 'flex';
        
        const response = await fetch('/analyze-data/', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error);
        }

        // Zeige Analyse-Container
        const analysisContainer = document.getElementById('analysis-container');
        analysisContainer.style.display = 'block';
        
        // Füge die erste Analyse als GPT-Nachricht hinzu
        document.getElementById('analysis-content').textContent = data.analysis;

        // Verarbeite Warnungen und Metadaten wie bisher
        // ... Rest des Codes bleibt unverändert ...

      } catch (error) {
        alert('Fehler beim Analysieren der Datei: ' + error.message);
      } finally {
        // Verstecke Spinner
        document.getElementById('spinner').style.display = 'none';
      }
    }
  </script>
{% endblock %} 