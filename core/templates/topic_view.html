{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .search-container {
      max-width: 1200px;
      margin: 40px auto 30px;
      padding: 0 20px;
      position: relative;
      display: flex;
      align-items: center;
      box-shadow: 0 6px 16px rgba(0,0,0,0.08);
      border-radius: 12px;
      background: white;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .search-container:focus-within {
      box-shadow: 0 8px 24px rgba(79, 128, 255, 0.15);
      transform: translateY(-2px);
    }
    
    .search-icon {
      position: absolute;
      left: 30px;
      color: #999;
      font-size: 20px;
      z-index: 2;
    }
    
    .search-container input[type="text"] {
      width: 100%;
      padding: 18px 18px 18px 60px;
      border: none;
      border-radius: 12px;
      font-size: 1.1em;
      box-sizing: border-box;
      margin: 0;
      transition: all 0.3s ease;
      height: 60px;
      color: #333;
      font-family: 'DINNextLTPro', sans-serif;
      background: transparent;
    }
    
    .search-container input[type="text"]:focus {
      outline: none;
    }
    
    .search-container input[type="text"]::placeholder {
      color: #aaa;
      transition: color 0.3s ease;
    }
    
    .search-container input[type="text"]:focus::placeholder {
      color: #ccc;
    }
    
    .topic-header {
      margin: 30px auto;
      max-width: 1200px;
      text-align: center;
      position: relative;
    }
    
    .topic-header h1 {
      color: #333;
      font-size: 2.5em;
      margin-bottom: 10px;
      font-family: 'DINNextLTPro', sans-serif;
    }
    
    .topic-header p {
      color: #666;
      font-size: 1.2em;
      margin-bottom: 30px;
      font-family: 'DINNextLTPro', sans-serif;
    }
    
    .back-button {
      background-color: #f8f9fa;
      color: #333;
      text-decoration: none;
      padding: 8px 16px;
      font-size: 16px;
      border-radius: 4px;
      transition: all 0.2s;
      position: absolute;
      left: 0;
      top: 0;
      font-family: 'DINNextLTPro', sans-serif;
    }
    
    .back-button:hover {
      background-color: #e9ecef;
    }
    
    .back-button i {
      margin-right: 10px;
    }
    
    /* Hier weitere Styles aus archive_main.html übernehmen... */
    #search-results {
      max-width: 1200px;
      width: calc(100% - 40px);
      margin: -5px auto 0;
      padding: 0;
      overflow-y: auto;
      max-height: 80vh;
      background: white;
      border: none;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
      position: relative;
      z-index: 990;
      display: none;
    }
    #search-results.active {
      display: block;
    }
    
    .charts-table-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      border: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      border-radius: 8px;
      overflow: hidden;
      font-family: 'DINNextLTPro', sans-serif;
    }
    
    thead tr {
      background: linear-gradient(135deg, #4f80ff 0%, #3a6cd9 100%);
    }
    
    th {
      padding: 15px 12px;
      text-align: left;
      color: white;
      font-weight: 500;
      font-size: 0.9em;
      letter-spacing: 0.5px;
      border: none;
    }
    
    tbody {
      background-color: white;
    }
    
    td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .table-flags {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .table-flag {
      display: inline-block;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.75em;
      font-weight: 500;
      text-transform: uppercase;
      text-align: center;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
      margin-bottom: 3px;
    }
    
    .table-flag.regional {
      background-color: #ff4444;
    }
    
    .table-flag.evergreen {
      background-color: #44bb55;
    }
    
    .table-flag.patch {
      background-color: #a044ff;
    }
    
    #loading-spinner {
      text-align: center;
      padding: 20px;
    }
    
    #loading-spinner div {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4f80ff;
      border-radius: 50%;
      margin: 0 auto;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      max-width: 200px;
    }
    
    .tag {
      display: inline-block;
      background-color: #eaeaea;
      color: #666;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 0.75em;
      white-space: nowrap;
      margin-bottom: 2px;
    }
    
    .highlight {
      background-color: rgba(79, 128, 255, 0.2);
      padding: 2px 4px;
      border-radius: 2px;
      font-weight: 500;
    }
  </style>
{% endblock %}

{% block title %}{{ topic_display }} - Archiv{% endblock %}

{% block content %}
  {% include 'partials/header.html' %}
  
  <div class="topic-header">
    <a href="{% url 'archive_main' %}" class="back-button">
      <i class="fas fa-arrow-left"></i> Zurück zur Übersicht
    </a>
    <h1>{{ topic_display }}</h1>
    <p>Alle Grafiken zum Thema {{ topic_display }}</p>
  </div>

  <div class="search-container">
    <i class="search-icon fas fa-search"></i>
    <input type="text" id="search-input" placeholder="Innerhalb des Themas {{ topic_display }} suchen...">
  </div>
  <div id="search-results"></div>

  <div class="charts-table-container">
    <h2 style="font-family: 'DINNextLTPro', sans-serif; color: #333; margin-bottom: 20px;">Grafiken werden geladen...</h2>
    <table>
      <thead>
        <tr>
          <th>Erstellung</th>
          <th>Thumb</th>
          <th>Titel</th>
          <th>ChartId</th>
          <th>Unterzeile</th>
          <th>Tags</th>
          <th>Infos</th>
        </tr>
      </thead>
      <tbody id="charts-table-body">
        <!-- Wird durch JavaScript gefüllt -->
      </tbody>
    </table>
    <div id="loading-spinner" style="display: none;">
      <div></div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      var searchInput = document.getElementById("search-input");
      var searchResults = document.getElementById("search-results");
      var chartsTableBody = document.getElementById("charts-table-body");
      var loadingSpinner = document.getElementById("loading-spinner");
      var currentSearchResults = [];
      var currentTablePage = 0;
      var isLoadingTable = false;
      var hasMoreCharts = true;
      
      // Setze den anfänglichen Suchbegriff, aber das Suchfeld bleibt leer
      const initialSearchTerm = "{{ initial_search }}";
      
      // Prüfe, ob ein zusätzlicher Suchbegriff im LocalStorage gespeichert ist
      const storedSearchQuery = localStorage.getItem('archiveSearchQuery');
      if (storedSearchQuery) {
        // Setze den gespeicherten Suchbegriff in das Suchfeld
        searchInput.value = storedSearchQuery;
        
        // Führe die Suche mit dem kombinierten Begriff durch
        fetchResults(initialSearchTerm + " " + storedSearchQuery);
      } else {
        // Führe die Suche nur mit dem Themenbegriff durch
        fetchResults(initialSearchTerm);
      }
      
      // Event Listener für die Suche
      if (searchInput) {
        searchInput.addEventListener("input", function() {
          var query = searchInput.value.trim();
          
          // Speichere den Suchbegriff im LocalStorage
          if (query) {
            localStorage.setItem('archiveSearchQuery', query);
          } else {
            localStorage.removeItem('archiveSearchQuery');
          }
          
          // Führe die kombinierte Suche durch (Thema + neuer Suchbegriff)
          if (query.length > 0) {
            // Füge den Themenbegriff immer hinzu
            fetchResults(initialSearchTerm + " " + query);
          } else {
            // Wenn das Suchfeld leer ist, verwende nur den Themenbegriff
            fetchResults(initialSearchTerm);
          }
        });
      }
      
      function fetchResults(query) {
        // Leere die Tabelle sofort, wenn eine Suche beginnt
        chartsTableBody.innerHTML = "<tr><td colspan='7' style='text-align: center; padding: 20px; color: #666;'>Suche läuft...</td></tr>";
        
        // Deaktiviere das automatische Laden weiterer Daten während der Suche
        hasMoreCharts = false;
        currentTablePage = 0;
        
        // Zeige den Spinner bei Suche
        loadingSpinner.style.display = 'block';
        
        fetch("/chart-search/?q=" + encodeURIComponent(query))
          .then(response => response.json())
          .then(data => {
            currentSearchResults = data.results;
            const totalResults = data.results.length;
            
            // Aktualisiere die Tabelle
            chartsTableBody.innerHTML = "";
            
            // Aktualisiere die Überschrift mit der Anzahl der gefundenen Grafiken
            const headerText = document.querySelector('.charts-table-container h2');
            
            if (totalResults === 0) {
              if (query === initialSearchTerm) {
                headerText.textContent = `Keine Grafiken zum Thema ${initialSearchTerm} gefunden`;
              } else {
                headerText.textContent = `Keine Grafiken zum Thema ${initialSearchTerm} mit Filter "${query.replace(initialSearchTerm, '').trim()}" gefunden`;
              }
              chartsTableBody.innerHTML = "<tr><td colspan='7' style='text-align: center; padding: 20px; color: #666;'>Keine Ergebnisse gefunden</td></tr>";
              loadingSpinner.style.display = 'none';
              return;
            }
            
            if (query === initialSearchTerm) {
              headerText.textContent = `${totalResults} Grafiken zum Thema ${initialSearchTerm}`;
            } else {
              const additionalSearchTerm = query.replace(initialSearchTerm, '').trim();
              headerText.textContent = `${totalResults} Grafiken zum Thema ${initialSearchTerm} mit Filter "${additionalSearchTerm}"`;
            }
            
            // Funktion zum Hervorheben des Suchbegriffs
            function highlightText(text, searchTerm) {
              if (!text || typeof text !== 'string') return '';
              
              // Unterstütze auch die Hervorhebung mehrerer Suchbegriffe
              if (searchTerm.includes(' ')) {
                const terms = searchTerm.split(' ').filter(term => term.length > 2);
                let highlightedText = text;
                
                terms.forEach(term => {
                  const regex = new RegExp(term, 'gi');
                  highlightedText = highlightedText.replace(regex, match => `<span class="highlight">${match}</span>`);
                });
                
                return highlightedText;
              }
              
              // Fallback für einzelnen Suchbegriff
              const regex = new RegExp(searchTerm, 'gi');
              return text.replace(regex, match => `<span class="highlight">${match}</span>`);
            }
            
            // Zeige die Ergebnisse in der Tabelle an
            data.results.forEach((chart, index) => {
              const row = document.createElement('tr');
              row.style.cursor = 'pointer';
              row.onclick = () => window.location.href = `/chart/${chart.chart_id}/`;
              
              // Generiere die Flags für die Tabelle
              let flagsHTML = '';
              if (chart.regional || chart.evergreen || chart.patch) {
                flagsHTML = '<div class="table-flags">';
                if (chart.regional) {
                  flagsHTML += '<span class="table-flag regional">regional</span>';
                }
                if (chart.evergreen) {
                  flagsHTML += '<span class="table-flag evergreen">evergreen</span>';
                }
                if (chart.patch) {
                  flagsHTML += '<span class="table-flag patch">patch</span>';
                }
                flagsHTML += '</div>';
              }
              
              // Generiere Tags-HTML für die formatierte Anzeige
              let tagsHTML = '';
              if (chart.tags && chart.tags.length > 0) {
                const tagsList = chart.tags.split(',').map(tag => tag.trim()).filter(tag => tag);
                if (tagsList.length > 0) {
                  tagsHTML = `<div class="tags-container">` + 
                    tagsList.map(tag => `<span class="tag">${highlightText(tag, query)}</span>`).join('') +
                    `</div>`;
                }
              }
              
              const formattedDate = chart.published_date ? formatDate(chart.published_date) : '';
              row.innerHTML = `
                <td>${formattedDate}</td>
                <td>
                  <div style="position: relative; width: 80px; height: 50px; overflow: hidden; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <img src="${chart.thumbnail}" alt="${chart.title}" width="80" style="object-fit: cover; width: 100%; height: 100%;">
                  </div>
                </td>
                <td style="font-weight: 500;">${highlightText(chart.title, query)}</td>
                <td style="color: #666; font-family: monospace; font-size: 0.9em;">${highlightText(chart.chart_id, query)}</td>
                <td style="color: #666;">${highlightText(chart.description || '', query)}</td>
                <td>${tagsHTML}</td>
                <td>${flagsHTML}</td>
              `;
              
              row.style.transition = 'background-color 0.2s ease';
              
              row.addEventListener('mouseover', function() {
                this.style.backgroundColor = '#f8f9ff';
              });
              
              row.addEventListener('mouseout', function() {
                this.style.backgroundColor = '';
              });
              
              chartsTableBody.appendChild(row);

              // Verzögertes Einblenden der Zeilen
              setTimeout(() => {
                row.classList.add('visible');
              }, index * 50);
            });
            
            // Verstecke den Spinner nach dem Laden
            loadingSpinner.style.display = 'none';
          })
          .catch(error => {
            console.error('Error fetching search results:', error);
            chartsTableBody.innerHTML = "<tr><td colspan='7' style='text-align: center; padding: 20px; color: #666;'>Ein Fehler ist aufgetreten</td></tr>";
            loadingSpinner.style.display = 'none';
          });
      }

      // Funktion zum Formatieren des Datums
      function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('de-DE', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });
      }
    });
  </script>
{% endblock %} 