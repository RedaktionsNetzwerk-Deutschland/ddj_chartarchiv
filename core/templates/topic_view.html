{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
  <link rel="stylesheet" href="https://static.rndtech.de/share/rnd/datenrecherche/font_awesome/css/all.min.css">
  <style>
    .search-container {
      max-width: 1200px;
      margin: 40px auto 30px;
      padding: 0 20px;
      position: relative;
      display: flex;
      align-items: center;
      box-shadow: 0 6px 16px rgba(0,0,0,0.08);
      border-radius: 12px;
      background: white;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .search-container:focus-within {
      box-shadow: 0 8px 24px rgba(79, 128, 255, 0.15);
      transform: translateY(-2px);
    }
    
    .search-icon {
      position: absolute;
      left: 30px;
      color: #999;
      font-size: 20px;
      z-index: 2;
    }
    
    .search-container input[type="text"] {
      width: 100%;
      padding: 18px 18px 18px 60px;
      border: none;
      border-radius: 12px;
      font-size: 1.1em;
      box-sizing: border-box;
      margin: 0;
      transition: all 0.3s ease;
      height: 60px;
      color: #333;
      font-family: 'DINNextLTPro', sans-serif;
      background: transparent;
    }
    
    .search-container input[type="text"]:focus {
      outline: none;
    }
    
    .search-container input[type="text"]::placeholder {
      color: #aaa;
      transition: color 0.3s ease;
    }
    
    .search-container input[type="text"]:focus::placeholder {
      color: #ccc;
    }
    
    /* Neue Styles für die Filter-Pills */
    .search-filters {
      max-width: 1200px;
      margin: 0 auto 20px;
      padding: 0 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      transition: all 0.3s ease;
    }
    
    .filter-pill {
      padding: 6px 14px;
      border-radius: 20px;
      background-color: #f0f0f0;
      color: #666;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 500;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      border: 2px solid transparent;
      font-family: 'DINNextLTPro', sans-serif;
    }
    
    .filter-pill:hover {
      background-color: #e8e8e8;
      transform: translateY(-1px);
    }
    
    .filter-pill.active {
      background-color: #e6eeff;
      color: #4f80ff;
      border-color: #4f80ff;
    }
    
    .filter-pill .pill-icon {
      font-size: 0.9em;
    }
    
    .filter-pill.active .pill-icon.check {
      display: inline-block;
    }
    
    .filter-pill:not(.active) .pill-icon.check {
      display: none;
    }
    
    .filter-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-right: 16px;
      align-items: center;
    }
    
    .filter-divider {
      width: 1px;
      height: 20px;
      background-color: #ddd;
      margin: 0 8px;
    }
    
    .filter-group-label {
      font-size: 0.8em;
      color: #999;
      margin-right: 4px;
      font-family: 'DINNextLTPro', sans-serif;
    }
    
    .filter-all {
      background-color: #f8f8f8;
      border: 1px dashed #ccc;
    }
    
    .filter-all.active {
      background-color: #f0f7ff;
      border: 1px solid #4f80ff;
    }
    
    .topic-header {
      margin: 30px auto;
      max-width: 1200px;
      text-align: center;
      position: relative;
    }
    
    .topic-header h1 {
      color: #333;
      font-size: 2.5em;
      margin-bottom: 10px;
      font-family: 'DINNextLTPro', sans-serif;
    }
    
    .topic-header p {
      color: #666;
      font-size: 1.2em;
      margin-bottom: 30px;
      font-family: 'DINNextLTPro', sans-serif;
    }
    
    .back-button {
      background-color: #f8f9fa;
      color: #333;
      text-decoration: none;
      padding: 8px 16px;
      font-size: 16px;
      border-radius: 4px;
      transition: all 0.2s;
      position: absolute;
      left: 0;
      top: 0;
      font-family: 'DINNextLTPro', sans-serif;
    }
    
    .back-button:hover {
      background-color: #e9ecef;
    }
    
    .back-button i {
      margin-right: 10px;
    }
    
    /* Hier weitere Styles aus archive_main.html übernehmen... */
    #search-results {
      max-width: 1200px;
      width: calc(100% - 40px);
      margin: -5px auto 0;
      padding: 0;
      overflow-y: auto;
      max-height: 80vh;
      background: white;
      border: none;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
      position: relative;
      z-index: 990;
      display: none;
    }
    #search-results.active {
      display: block;
    }
    
    .charts-table-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      border: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      border-radius: 8px;
      overflow: hidden;
      font-family: 'DINNextLTPro', sans-serif;
    }
    
    thead tr {
      background: linear-gradient(135deg, #4f80ff 0%, #3a6cd9 100%);
    }
    
    th {
      padding: 15px 12px;
      text-align: left;
      color: white;
      font-weight: 500;
      font-size: 0.9em;
      letter-spacing: 0.5px;
      border: none;
    }
    
    tbody {
      background-color: white;
    }
    
    td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .table-flags {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .table-flag {
      display: inline-block;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.75em;
      font-weight: 500;
      text-transform: uppercase;
      text-align: center;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
      margin-bottom: 3px;
    }
    
    .table-flag.regional {
      background-color: #ff4444;
    }
    
    .table-flag.evergreen {
      background-color: #44bb55;
    }
    
    .table-flag.patch {
      background-color: #a044ff;
    }
    
    #loading-spinner {
      text-align: center;
      padding: 20px;
    }
    
    #loading-spinner div {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4f80ff;
      border-radius: 50%;
      margin: 0 auto;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      max-width: 200px;
    }
    
    .tag {
      display: inline-block;
      background-color: #eaeaea;
      color: #666;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 0.75em;
      white-space: nowrap;
      margin-bottom: 2px;
    }
    
    .highlight {
      background-color: rgba(79, 128, 255, 0.2);
      padding: 2px 4px;
      border-radius: 2px;
      font-weight: 500;
    }
  </style>
{% endblock %}

{% block title %}{{ topic_display }} - RND-Grafikarchiv{% endblock %}

{% block content %}
  {% include 'partials/header.html' %}
  
  <div class="topic-header">
    <a href="{% url 'archive_main' %}" class="back-button">
      <i class="fas fa-arrow-left"></i> Zurück zur Übersicht
    </a>
    <h1>{{ topic_display }}</h1>
    <p>Hier findest du alle Grafiken zum Thema {{ topic_display }}</p>
  </div>
  
  <div class="search-container">
    <i class="search-icon fas fa-search"></i>
    <input type="text" id="search-input" placeholder="Grafiken im Bereich '{{ topic_display }}' durchsuchen..." value="{{ initial_search }}">
  </div>
  
  <!-- Filter-Pills für die feldspezifische Suche -->
  <div class="search-filters">
    <div class="filter-group">
      <button class="filter-pill filter-all active" data-field="all">
        <i class="fas fa-check-circle pill-icon check"></i>
        <span>Alle Felder</span>
      </button>
    </div>
    
    <div class="filter-group">
      <span class="filter-group-label">Inhalte:</span>
      <button class="filter-pill" data-field="title">
        <i class="fas fa-check-circle pill-icon check"></i>
        <span>Titel</span>
      </button>
      <button class="filter-pill" data-field="description">
        <i class="fas fa-check-circle pill-icon check"></i>
        <span>Beschreibung</span>
      </button>
      <button class="filter-pill" data-field="notes">
        <i class="fas fa-check-circle pill-icon check"></i>
        <span>Notizen</span>
      </button>
      <button class="filter-pill" data-field="comments">
        <i class="fas fa-check-circle pill-icon check"></i>
        <span>Kommentare</span>
      </button>
    </div>
    
    <div class="filter-group">
      <span class="filter-group-label">Metadaten:</span>
      <button class="filter-pill" data-field="tags">
        <i class="fas fa-check-circle pill-icon check"></i>
        <span>Tags</span>
      </button>
      <button class="filter-pill" data-field="chart_id">
        <i class="fas fa-check-circle pill-icon check"></i>
        <span>Chart-ID</span>
      </button>
      <button class="filter-pill" data-field="author">
        <i class="fas fa-check-circle pill-icon check"></i>
        <span>Autor</span>
      </button>
    </div>
  </div>
  
  <!-- Suche Ergebnisse Container -->
  <div id="search-results"></div>
  
  <div class="charts-table-container">
    <h2 style="font-family: 'DINNextLTPro', sans-serif; color: #333; margin-bottom: 20px;">Grafiken werden geladen...</h2>
    <table>
      <thead>
        <tr>
          <th>Erstellung</th>
          <th>Thumb</th>
          <th>Titel</th>
          <th>ChartId</th>
          <th>Unterzeile</th>
          <th>Tags</th>
          <th>Infos</th>
        </tr>
      </thead>
      <tbody id="charts-table-body">
        <!-- Wird durch JavaScript gefüllt -->
      </tbody>
    </table>
    <div id="loading-spinner" style="display: none;">
      <div></div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // Variablen für die Suche
      var searchInput = document.getElementById("search-input");
      var searchResults = document.getElementById("search-results");
      var chartsTableBody = document.getElementById("charts-table-body");
      var loadingSpinner = document.getElementById("loading-spinner");
      var currentPage = 0;
      var hasMoreResults = false;
      var isLoadingResults = false;
      var currentSearchTerm = "{{ initial_search }}";
      var isFirstLoad = true;
      
      // Neue Variable für die aktiven Suchfelder
      var activeSearchFields = ['all'];
      
      // Debug-Logger
      function debugLog(message) {
        console.log(`[DEBUG] ${message}`);
      }
      
      // Event-Handler für die Filter-Pills
      document.querySelectorAll('.filter-pill').forEach(pill => {
        pill.addEventListener('click', function() {
          const field = this.getAttribute('data-field');
          
          if (field === 'all') {
            // Wenn "Alle Felder" geklickt wird
            if (this.classList.contains('active')) {
              // Wenn bereits aktiv, nicht deaktivieren
              return;
            } else {
              // Wenn nicht aktiv, alle anderen Filter deaktivieren
              document.querySelectorAll('.filter-pill').forEach(p => {
                p.classList.remove('active');
              });
              this.classList.add('active');
              activeSearchFields = ['all'];
            }
          } else {
            // Wenn ein spezifisches Feld geklickt wird
            
            // "Alle Felder" deaktivieren
            document.querySelector('.filter-pill[data-field="all"]').classList.remove('active');
            
            // Dieses Feld umschalten
            this.classList.toggle('active');
            
            // Liste der aktiven Felder aktualisieren
            if (this.classList.contains('active')) {
              // Feld zur Liste hinzufügen, wenn es noch nicht drin ist
              if (!activeSearchFields.includes(field)) {
                activeSearchFields.push(field);
              }
              // "all" aus der Liste entfernen, falls vorhanden
              activeSearchFields = activeSearchFields.filter(f => f !== 'all');
            } else {
              // Feld aus der Liste entfernen
              activeSearchFields = activeSearchFields.filter(f => f !== field);
            }
            
            // Wenn keine Felder mehr aktiv sind, "Alle Felder" wieder aktivieren
            if (activeSearchFields.length === 0 || 
                (activeSearchFields.length === 1 && activeSearchFields[0] === 'all')) {
              document.querySelector('.filter-pill[data-field="all"]').classList.add('active');
              activeSearchFields = ['all'];
            }
          }
          
          debugLog(`Aktive Suchfelder: ${activeSearchFields.join(', ')}`);
          
          // Suche erneut ausführen, wenn ein Suchbegriff vorhanden ist
          if (searchInput.value.trim()) {
            // Suche mit den neuen Filtereinstellungen ausführen
            performSearch(searchInput.value.trim());
          } else if (currentSearchTerm) {
            // Wenn ein initialer Suchbegriff gesetzt wurde
            performSearch(currentSearchTerm);
          }
        });
      });
      
      // Funktion zum Erstellen der Fetch-URL mit den aktiven Suchfeldern
      function createSearchUrl(query, limit = 50, offset = 0) {
        let url = `/chart-search/?q=${encodeURIComponent(query)}&limit=${limit}&offset=${offset}&logical_op=AND`;
        
        // Füge Suchfelder-Parameter hinzu, wenn spezifische Felder ausgewählt sind
        if (!activeSearchFields.includes('all')) {
          url += `&search_fields=${activeSearchFields.join(',')}`;
        }
        
        return url;
      }
      
      // Funktion für die Suche
      function performSearch(query) {
        if (isLoadingResults) return;
        
        isLoadingResults = true;
        loadingSpinner.style.display = "block";
        chartsTableBody.innerHTML = "";
        
        // URL für die Suche erstellen
        const fetchUrl = createSearchUrl(query);
        debugLog(`Suche: ${fetchUrl}`);
        
        // Suche ausführen
        fetch(fetchUrl)
          .then(response => response.json())
          .then(data => {
            isLoadingResults = false;
            currentPage = 0;
            hasMoreResults = data.has_more;
            
            // Überschrift anpassen
            const headerText = document.querySelector('.topic-header h1');
            const resultCount = data.total_count || 0;
            
            if (isFirstLoad) {
              headerText.textContent = `${resultCount} Grafiken zum Thema "{{ topic_display }}"`;
              isFirstLoad = false;
            } else {
              headerText.textContent = `${resultCount} Grafiken für "${query}" in "{{ topic_display }}"`;
            }
            
            // Tabelle leeren
            chartsTableBody.innerHTML = "";
            
            if (data.results.length === 0) {
              chartsTableBody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 20px;">Keine Ergebnisse gefunden</td></tr>`;
            } else {
              // Ergebnisse anzeigen
              data.results.forEach(chart => renderChartRow(chart));
            }
            
            // Lade-Spinner ausblenden
            loadingSpinner.style.display = "none";
            
            // Aktuelle Suchanfrage speichern
            currentSearchTerm = query;
          })
          .catch(error => {
            console.error("Fehler bei der Suche:", error);
            chartsTableBody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 20px;">Ein Fehler ist aufgetreten</td></tr>`;
            isLoadingResults = false;
            loadingSpinner.style.display = "none";
          });
      }
      
      // Funktion zum Rendern einer Tabellenzeile
      function renderChartRow(chart) {
        const row = document.createElement('tr');
        row.style.cursor = 'pointer';
        row.setAttribute('data-href', `/chart/${chart.chart_id}/`);
        
        // Generiere die Flags für die Tabelle
        let flagsHTML = '';
        if (chart.regional || chart.evergreen || chart.patch) {
          flagsHTML = '<div class="table-flags">';
          if (chart.regional) {
            flagsHTML += '<span class="table-flag regional">regional</span>';
          }
          if (chart.evergreen) {
            flagsHTML += '<span class="table-flag evergreen">evergreen</span>';
          }
          if (chart.patch) {
            flagsHTML += '<span class="table-flag patch">patch</span>';
          }
          flagsHTML += '</div>';
        }
        
        // Generiere Tags-HTML für die formatierte Anzeige
        let tagsHTML = '';
        if (chart.tags && chart.tags.length > 0) {
          const tagsList = chart.tags.split(',').map(tag => tag.trim()).filter(tag => tag);
          if (tagsList.length > 0) {
            tagsHTML = `<div class="tags-container">` + 
              tagsList.map(tag => `<span class="tag">${tag}</span>`).join('') +
              `</div>`;
          }
        }
        
        // Formatiere das Datum
        const formattedDate = chart.published_date ? formatDate(chart.published_date) : '';
        
        // Erstellung der Tabellenzeile mit Link in jeder Zelle
        const cells = [
          `<td><a href="/chart/${chart.chart_id}/" style="text-decoration: none; color: inherit; display: block;">${formattedDate}</a></td>`,
          `<td><a href="/chart/${chart.chart_id}/" style="text-decoration: none; color: inherit; display: block;">
            <div style="position: relative; width: 80px; height: 50px; overflow: hidden; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <img src="${chart.thumbnail}" alt="${chart.title}" width="80" style="object-fit: cover; width: 100%; height: 100%;">
            </div></a>
          </td>`,
          `<td style="font-weight: 500;"><a href="/chart/${chart.chart_id}/" style="text-decoration: none; color: inherit; display: block;">${chart.title}</a></td>`,
          `<td style="font-family: monospace; font-size: 0.9em;"><a href="/chart/${chart.chart_id}/" style="text-decoration: none; color: inherit; display: block;">${chart.chart_id}</a></td>`,
          `<td><a href="/chart/${chart.chart_id}/" style="text-decoration: none; color: inherit; display: block;">${chart.description || ''}</a></td>`,
          `<td><a href="/chart/${chart.chart_id}/" style="text-decoration: none; color: inherit; display: block;">${tagsHTML}</a></td>`,
          `<td><a href="/chart/${chart.chart_id}/" style="text-decoration: none; color: inherit; display: block;">${flagsHTML}</a></td>`
        ];
        
        row.innerHTML = cells.join('');
        
        // Event-Listener hinzufügen, um die Zeile klickbar zu machen
        row.addEventListener('click', function(e) {
          // Verhindern des Klick-Events, wenn der Benutzer auf einen Link geklickt hat
          if (e.target.tagName === 'A' || e.target.closest('a')) {
            return;
          }
          window.location.href = this.getAttribute('data-href');
        });
        
        chartsTableBody.appendChild(row);
      }
      
      // Funktion zum Formatieren des Datums
      function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('de-DE', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });
      }
      
      // Debounce-Funktion für die Suche
      function debounce(func, wait) {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }
      
      // Eventlistener für die Suche
      if (searchInput) {
        searchInput.addEventListener("input", debounce(function() {
          const query = this.value.trim();
          if (query.length > 2) {
            performSearch(query);
          } else if (query.length === 0 && currentSearchTerm) {
            // Wenn das Suchfeld geleert wird, führe die ursprüngliche Suche erneut aus
            performSearch("{{ initial_search }}");
          }
        }, 300));
      }
      
      // Führe die initiale Suche durch
      performSearch("{{ initial_search }}");
      
      // Event-Listener für Scroll hinzufügen (für Lazy Loading)
      window.addEventListener('scroll', function() {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
          if (hasMoreResults && !isLoadingResults) {
            loadMoreResults();
          }
        }
      });
      
      // Funktion zum Laden weiterer Ergebnisse
      function loadMoreResults() {
        if (isLoadingResults || !hasMoreResults) return;
        
        isLoadingResults = true;
        loadingSpinner.style.display = "block";
        
        // Nächste Seite laden
        currentPage++;
        
        // URL für die nächste Seite erstellen
        const fetchUrl = createSearchUrl(currentSearchTerm, 50, currentPage * 50);
        debugLog(`Lade mehr Ergebnisse: ${fetchUrl}`);
        
        // Weitere Ergebnisse abrufen
        fetch(fetchUrl)
          .then(response => response.json())
          .then(data => {
            isLoadingResults = false;
            hasMoreResults = data.has_more;
            
            // Ergebnisse anzeigen
            data.results.forEach(chart => renderChartRow(chart));
            
            // Lade-Spinner ausblenden
            loadingSpinner.style.display = "none";
          })
          .catch(error => {
            console.error("Fehler beim Laden weiterer Ergebnisse:", error);
            isLoadingResults = false;
            loadingSpinner.style.display = "none";
          });
      }
    });
  </script>
{% endblock %} 