{% extends 'base.html' %}
{% load user_tags %}

{% block extra_head %}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    .chart-detail-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
    }
    
    .back-button-container {
      margin: 20px 0 40px;
      text-align: left;
    }
    
    .back-button {
      display: inline-flex;
      align-items: center;
      background-color: #f5f5f5;
      color: #333;
      padding: 10px 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      text-decoration: none;
      font-family: 'DINNextLTPro', sans-serif;
      transition: all 0.3s ease;
    }
    
    .back-button:hover {
      background-color: #e0e0e0;
      transform: translateY(-2px);
    }
    
    .back-button i {
      margin-right: 10px;
    }
    
    .chart-image-container {
      width: 60%;
      max-width: 600px;
      margin: 0 auto 40px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      position: relative;
    }
    .chart-image {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 4px;
      image-rendering: -webkit-optimize-contrast; /* Verbessert die Bildschärfe in Chrome */
      image-rendering: crisp-edges; /* Verbessert die Bildschärfe in Firefox */
    }
    /* Styles für das Fehlen eines Thumbnails */
    .no-thumbnail {
      width: 100%;
      height: 200px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: #f5f5f5;
      border-radius: 4px;
      text-align: center;
    }
    /* Styles für Flags auf dem Thumbnail */
    .chart-flags {
      position: absolute;
      top: 30px;
      right: 0;
      width: 160px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 10;
      transform: translateX(25%);
    }
    .chart-flag {
      display: inline-block;
      color: white;
      padding: 8px 24px;
      border-radius: 6px;
      font-size: 1.0em;
      font-weight: 500;
      text-transform: uppercase;
      text-align: center;
      font-family: 'DINNextLTPro', sans-serif;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .chart-flag.regional {
      background-color: #ff4444;
    }
    .chart-flag.evergreen {
      background-color: #44bb55;
    }
    .chart-flag.patch {
      background-color: #a044ff;
    }
    /* Styles für Tags-Anzeige */
    .chart-tags {
      margin-top: 15px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
    }
    .chart-tag {
      display: inline-block;
      background-color: #e0e0e0;
      color: #555;
      padding: 8px 14px;
      border-radius: 6px;
      font-size: 0.9em;
      font-weight: 500;
      font-family: 'DINNextLTPro', sans-serif;
      margin: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
    }
    
    .chart-tag:hover {
      background-color: #d0d0d0;
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }
    .chart-content {
      max-width: 800px;
      margin: 0 auto;
      text-align: center;
    }
    .chart-title {
      font-family: 'DINNextLTPro', sans-serif;
      font-size: 2em;
      color: #333;
      margin-bottom: 20px;
      line-height: 1.3;
    }
    .chart-description {
      font-size: 1.1em;
      color: #666;
      line-height: 1.6;
      margin-bottom: 40px;
    }
    .action-buttons {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 40px;
    }
    .action-button {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 14px 24px;
      background-color: #ffffff;
      color: #4f80ff;
      border: 2px solid #4f80ff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.05em;
      font-weight: 500;
      transition: all 0.25s ease;
      min-width: 135px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      font-family: 'DINNextLTPro', sans-serif;
      position: relative;
      overflow: hidden;
      z-index: 1;
    }
    .action-button:before {
      content: "";
      position: absolute;
      z-index: -1;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #4f80ff;
      transform: scaleX(0);
      transform-origin: 0 50%;
      transition: transform 0.3s ease-out;
    }
    .action-button:hover {
      color: white;
      box-shadow: 0 4px 12px rgba(79, 128, 255, 0.25);
      transform: translateY(-3px);
    }
    .action-button:hover:before {
      transform: scaleX(1);
    }
    .action-button i {
      margin-right: 10px;
      font-size: 1.1em;
    }
    
    /* Stil für deaktivierte Buttons */
    .action-button.disabled {
      background-color: #f0f0f0;
      color: #999;
      border-color: #ddd;
      cursor: not-allowed;
      box-shadow: none;
      pointer-events: none;
    }
    
    .action-button.disabled:before {
      display: none;
    }
    
    /* Hinweis für nicht verfügbare Funktionen */
    .feature-unavailable {
      margin-top: 20px;
      padding: 15px;
      background-color: #fff3cd;
      border-left: 4px solid #ffc107;
      border-radius: 4px;
      font-family: 'Source Serif Pro', serif;
      font-size: 0.9em;
      color: #856404;
      line-height: 1.4;
      display: none; /* Standard: ausgeblendet */
    }
    
    /* Neuer Stil für die Datums-Textmarke */
    .chart-dates {
      text-align: center;
      margin-bottom: 15px;
      font-size: 0.9em;
      color: #666;
      font-family: 'DINNextLTPro', sans-serif;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
      background-color: #f5f5f5;
      padding: 8px 15px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
  </style>
{% endblock %}

{% block title %}RND-Grafikarchiv{% endblock %}

{% block content %}
  {% include 'partials/header.html' %}
  
  <div class="chart-detail-container">
    <div class="back-button-container">
      <a href="{% url 'archive_main' %}" class="back-button">
        <i class="fas fa-arrow-left"></i> Zurück zur Hauptansicht
      </a>
    </div>
    
    <!-- Neue Datums-Textmarke außerhalb des Containers -->
    <div class="chart-dates" style="background-color: #f0f0f0; padding: 10px; border-radius: 6px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); border: 1px solid #e0e0e0;">
      {% if chart.published_date %}
      Erstellung: {{ chart.published_date|date:"d.m.Y" }}{% endif %}{% if chart.last_modified_date %}, letzte Bearbeitung: {{ chart.last_modified_date|date:"d.m.Y" }}{% endif %}
    </div>
    
    <div class="chart-image-container">
      {% if chart.thumbnail %}
      <img src="{{ chart.thumbnail.url }}" alt="{{ chart.title }}" class="chart-image">
      {% else %}
      <div class="no-thumbnail">
        <i class="fas fa-chart-bar" style="font-size: 3em; color: #ddd; margin-bottom: 10px;"></i>
        <p style="color: #999; font-style: italic;">Kein Vorschaubild verfügbar</p>
      </div>
      {% endif %}
      <div class="chart-flags">
        {% if chart.regional %}
        <span class="chart-flag regional">regional</span>
        {% endif %}
        {% if chart.evergreen %}
        <span class="chart-flag evergreen">evergreen</span>
        {% endif %}
        {% if chart.patch %}
        <span class="chart-flag patch">patch</span>
        {% endif %}
      </div>
    </div>
    
    <div class="chart-content">
      <h1 class="chart-title">{{ chart.title }}</h1>
      
      <!-- Tag-Anzeige -->
      {% if tag_list %}
      <div class="chart-tags">
        {% for tag in tag_list %}
          <span class="chart-tag">{{ tag }}</span>
        {% endfor %}
      </div>
      {% endif %}
      
      <p class="chart-description">{{ chart.description }}</p>
      
      <!-- Autor und E-Mail Informationen -->
      {% if chart.author or chart.author_email %}
      <p class="chart-author-info" style="font-size: 0.9em; color: #777; margin-top: -20px; margin-bottom: 30px; font-style: italic;">
        {% if chart.author %}Autor/-in: {{ chart.author }}{% endif %}
        {% if chart.author and chart.author_email %}, {% endif %}
        {% if chart.author_email %}E-Mail: <a href="mailto:{{ chart.author_email }}" style="color: #4f80ff; text-decoration: none;">{{ chart.author_email }}</a>{% endif %}
      </p>
      {% endif %}
      
      <div class="action-buttons">
        <button class="action-button" id="codeButton" onclick="handleJS()"><i class="fas fa-code"></i>Code</button>
        <button class="action-button" id="iframeButton" onclick="handleIframe()"><i class="fas fa-window-maximize"></i>iframe</button>
        <button class="action-button" id="printButton" onclick="handlePrint()"><i class="fas fa-print"></i>Print</button>
        <button class="action-button" id="onlineButton" onclick="handleOnline()"><i class="fas fa-globe"></i>online</button>
        {% if user|has_group:"social" %}
        <button class="action-button" id="socialButton" onclick="handleSocial()"><i class="fas fa-share-alt"></i>Social</button>
        {% endif %}
      </div>

      <!-- Hinweis für nicht verfügbare Funktionen -->
      <div id="featureUnavailableMessage" class="feature-unavailable">
        Hinweis: Für diese Grafik stehen einige Funktionen nicht zur Verfügung, da es sich nicht um eine Datawrapper-Grafik handelt. Die Grafik ist lediglich online einsetzbar.
      </div>

      <!-- Allgemeiner Hinweis -->
      <div style="
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-left: 4px solid #4f80ff;
        border-radius: 4px;
        font-family: 'Source Serif Pro', serif;
        font-size: 0.9em;
        color: #666;
        line-height: 1.4;
      ">
        Für Digital-Export bitte ein Format auswählen. "Code" spielt einen Javascript-Code aus, unter "iframe" finden sich die gewohnten Ausspielvarianten als responsives Iframe.
      </div>
    </div>
  </div>

  <script>
    // Funktionen für Buttons
    function handleJS() {
      // Code-Button-Funktionalität - kopiere embed_js in die Zwischenablage
      let embedCode = `{{ chart.embed_js|escapejs }}`;
      
      // Wenn embed_js leer ist, verwende Standard-Code mit der richtigen Chart-ID
      if (!embedCode.trim()) {
        embedCode = `<script src="https://static.rndtech.de/share/rnd/datenrecherche/script/dw_chart_min.js" defer><\/script>
<dw-chart chart-id="{{ chart.chart_id }}"></dw-chart>`;
      }
      
      navigator.clipboard.writeText(embedCode).then(function() {
        // Erfolgsmeldung
        showToast("JavaScript-Code wurde in die Zwischenablage kopiert");
      }).catch(function(err) {
        // Fallback wenn das Clipboard API nicht funktioniert
        console.error('Fehler beim Kopieren: ', err);
        fallbackCopyToClipboard(embedCode);
      });
    }
    
    function handleIframe() {
      // iframe-Button-Funktionalität - kopiere iframe_url in die Zwischenablage
      const iframeCode = `{{ chart.iframe_url|escapejs }}`;
      
      navigator.clipboard.writeText(iframeCode).then(function() {
        // Erfolgsmeldung
        showToast("Iframe-Code wurde in die Zwischenablage kopiert");
      }).catch(function(err) {
        // Fallback wenn das Clipboard API nicht funktioniert
        console.error('Fehler beim Kopieren: ', err);
        fallbackCopyToClipboard(iframeCode);
      });
    }
    
    // Fallback-Methode für ältere Browser
    function fallbackCopyToClipboard(text) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      
      // Verhindere Scrolling zur textArea
      textArea.style.top = "0";
      textArea.style.left = "0";
      textArea.style.position = "fixed";
      
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          showToast("Code wurde in die Zwischenablage kopiert");
        } else {
          showToast("Kopieren fehlgeschlagen, bitte manuell kopieren", "error");
        }
      } catch (err) {
        console.error('Fallback: Fehler beim Kopieren', err);
        showToast("Kopieren fehlgeschlagen, bitte manuell kopieren", "error");
      }
      
      document.body.removeChild(textArea);
    }
    
    // Toast-Nachricht anzeigen
    function showToast(message, type = "success") {
      // Toast-Container erstellen falls noch nicht vorhanden
      let toastContainer = document.getElementById('toast-container');
      if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.style.position = 'fixed';
        toastContainer.style.bottom = '20px';
        toastContainer.style.right = '20px';
        toastContainer.style.zIndex = '1000';
        document.body.appendChild(toastContainer);
      }
      
      // Toast-Element erstellen
      const toast = document.createElement('div');
      toast.style.backgroundColor = type === 'success' ? '#4CAF50' : '#F44336';
      toast.style.color = 'white';
      toast.style.padding = '15px 20px';
      toast.style.marginBottom = '10px';
      toast.style.borderRadius = '4px';
      toast.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
      toast.style.opacity = '0';
      toast.style.transition = 'opacity 0.3s ease-in-out';
      toast.textContent = message;
      
      // Toast zum Container hinzufügen
      toastContainer.appendChild(toast);
      
      // Animation für Einblenden
      setTimeout(() => {
        toast.style.opacity = '1';
      }, 10);
      
      // Nach 3 Sekunden ausblenden und entfernen
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
          toastContainer.removeChild(toast);
        }, 300);
      }, 3000);
    }
    
    function handlePrint() {
      // Weiterleitung zur Print-Seite
      window.location.href = "{% url 'chart_print' chart.chart_id %}";
    }
    
    function handleOnline() {
      // Weiterleitung zur Online-Seite
      window.location.href = "{% url 'chart_online' chart.chart_id %}";
    }
    
    function handleSocial() {
      // Social-Button-Funktionalität
      alert("Social-Media-Optionen werden vorbereitet...");
    }
    
    function goBack() {
      // Direkte Weiterleitung zur archive_main URL, ignoriert den Browser-Verlauf
      window.location.href = "{% url 'archive_main' %}";
      return false;
    }
    
    // Überprüfung der Chart-ID
    document.addEventListener("DOMContentLoaded", function() {
      const chartId = "{{ chart.chart_id }}";
      const isValidFormat = /^[a-zA-Z0-9]{5}$/.test(chartId);
      
      if (!isValidFormat) {
        // Buttons ausgrauen (außer Code-Button)
        const buttonsToDisable = ['iframeButton', 'printButton', 'onlineButton', 'socialButton'];
        
        buttonsToDisable.forEach(buttonId => {
          const button = document.getElementById(buttonId);
          if (button) {
            button.classList.add('disabled');
            button.disabled = true;
            button.setAttribute('title', 'Diese Funktion ist für diese Grafik nicht verfügbar');
            
            // Event-Listener entfernen
            const originalOnClick = button.getAttribute('onclick');
            button.setAttribute('data-original-onclick', originalOnClick);
            button.removeAttribute('onclick');
            
            button.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              return false;
            });
          }
        });
        
        // Hinweismeldung anzeigen
        const featureUnavailableMessage = document.getElementById('featureUnavailableMessage');
        if (featureUnavailableMessage) {
          featureUnavailableMessage.style.display = 'block';
        }
      }
    });
  </script>
{% endblock %} 