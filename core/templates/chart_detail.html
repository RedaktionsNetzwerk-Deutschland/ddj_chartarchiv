{% extends 'base.html' %}

{% block extra_head %}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    .chart-detail-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
    }
    
    .back-button-container {
      margin: 20px 0 40px;
      text-align: left;
    }
    
    .back-button {
      display: inline-flex;
      align-items: center;
      background-color: #f5f5f5;
      color: #333;
      padding: 10px 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      text-decoration: none;
      font-family: 'DINNextLTPro', sans-serif;
      transition: all 0.3s ease;
    }
    
    .back-button:hover {
      background-color: #e0e0e0;
      transform: translateY(-2px);
    }
    
    .back-button i {
      margin-right: 10px;
    }
    
    .chart-image-container {
      width: 50%;
      max-width: 500px;
      margin: 0 auto 40px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      position: relative;
    }
    .chart-image {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 4px;
    }
    /* Styles für Flags auf dem Thumbnail */
    .chart-flags {
      position: absolute;
      top: 30px;
      right: 0;
      width: 160px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 10;
      transform: translateX(25%);
    }
    .chart-flag {
      display: inline-block;
      color: white;
      padding: 8px 24px;
      border-radius: 6px;
      font-size: 1.0em;
      font-weight: 500;
      text-transform: uppercase;
      text-align: center;
      font-family: 'DINNextLTPro', sans-serif;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .chart-flag.regional {
      background-color: #ff4444;
    }
    .chart-flag.evergreen {
      background-color: #44bb55;
    }
    .chart-flag.patch {
      background-color: #a044ff;
    }
    /* Styles für Tags-Anzeige */
    .chart-tags {
      margin-top: 15px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
    }
    .chart-tag {
      display: inline-block;
      background-color: #e0e0e0;
      color: #555;
      padding: 8px 14px;
      border-radius: 6px;
      font-size: 0.9em;
      font-weight: 500;
      font-family: 'DINNextLTPro', sans-serif;
      margin: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
    }
    
    .chart-tag:hover {
      background-color: #d0d0d0;
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }
    .chart-content {
      max-width: 800px;
      margin: 0 auto;
      text-align: center;
    }
    .chart-title {
      font-family: 'DINNextLTPro', sans-serif;
      font-size: 2em;
      color: #333;
      margin-bottom: 20px;
      line-height: 1.3;
    }
    .chart-description {
      font-size: 1.1em;
      color: #666;
      line-height: 1.6;
      margin-bottom: 40px;
    }
    .action-buttons {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 40px;
    }
    .action-button {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 14px 24px;
      background-color: #ffffff;
      color: #4f80ff;
      border: 2px solid #4f80ff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.05em;
      font-weight: 500;
      transition: all 0.25s ease;
      min-width: 135px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      font-family: 'DINNextLTPro', sans-serif;
      position: relative;
      overflow: hidden;
      z-index: 1;
    }
    .action-button:before {
      content: "";
      position: absolute;
      z-index: -1;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #4f80ff;
      transform: scaleX(0);
      transform-origin: 0 50%;
      transition: transform 0.3s ease-out;
    }
    .action-button:hover {
      color: white;
      box-shadow: 0 4px 12px rgba(79, 128, 255, 0.25);
      transform: translateY(-3px);
    }
    .action-button:hover:before {
      transform: scaleX(1);
    }
    .action-button i {
      margin-right: 10px;
      font-size: 1.1em;
    }
    
    /* Neuer Stil für die Datums-Textmarke */
    .chart-dates {
      text-align: center;
      margin-bottom: 15px;
      font-size: 0.9em;
      color: #666;
      font-family: 'DINNextLTPro', sans-serif;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
      background-color: #f5f5f5;
      padding: 8px 15px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
  </style>
{% endblock %}

{% block title %}{{ chart.title }}{% endblock %}

{% block content %}
  {% include 'partials/header.html' %}
  
  <div class="chart-detail-container">
    <div class="back-button-container">
      <a href="{% url 'archive_main' %}" class="back-button" onclick="return goBack()">
        <i class="fas fa-arrow-left"></i> Zurück zur Übersicht
      </a>
    </div>
    
    <!-- Neue Datums-Textmarke außerhalb des Containers -->
    <div class="chart-dates" style="background-color: #f0f0f0; padding: 10px; border-radius: 6px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); border: 1px solid #e0e0e0;">
      {% if chart.published_date %}
      Erstellung: {{ chart.published_date|date:"d.m.Y" }}{% endif %}{% if chart.last_modified_date %}, letzte Bearbeitung: {{ chart.last_modified_date|date:"d.m.Y" }}{% endif %}
    </div>
    
    <div class="chart-image-container">
      <img src="{{ chart.thumbnail.url }}" alt="{{ chart.title }}" class="chart-image">
      <div class="chart-flags">
        {% if chart.regional %}
        <span class="chart-flag regional">regional</span>
        {% endif %}
        {% if chart.evergreen %}
        <span class="chart-flag evergreen">evergreen</span>
        {% endif %}
        {% if chart.patch %}
        <span class="chart-flag patch">patch</span>
        {% endif %}
      </div>
    </div>
    
    <div class="chart-content">
      <h1 class="chart-title">{{ chart.title }}</h1>
      
      <!-- Tag-Anzeige -->
      {% if tag_list %}
      <div class="chart-tags">
        {% for tag in tag_list %}
          <span class="chart-tag">{{ tag }}</span>
        {% endfor %}
      </div>
      {% endif %}
      
      <p class="chart-description">{{ chart.description }}</p>
      
      <div class="action-buttons">
        <button class="action-button" onclick="handleJS()"><i class="fas fa-code"></i>Code</button>
        <button class="action-button" onclick="handleIframe()"><i class="fas fa-window-maximize"></i>iframe</button>
        <button class="action-button" onclick="handlePrint()"><i class="fas fa-print"></i>Print</button>
        <button class="action-button" onclick="handleSocial()"><i class="fas fa-share-alt"></i>Social</button>
      </div>

      <!-- Neue Hinweisbox -->
      <div style="
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-left: 4px solid #4f80ff;
        border-radius: 4px;
        font-family: 'Source Serif Pro', serif;
        font-size: 0.9em;
        color: #666;
        line-height: 1.4;
      ">
        Für Digital-Export bitte ein Format auswählen. JS spielt einen Javascript-Code aus, unter iframe finden sich die gewohnten Ausspielvarianten.
      </div>
    </div>
  </div>

  <script>
    function handleJS() {
      // Embed-Code aus der Datenbank oder Standard-Template erstellen
      let embedCode = `{{ chart.embed_js|escapejs }}`;
      
      // Wenn embed_js leer ist, Standard-Template mit chart_id verwenden
      if (!embedCode || embedCode.trim() === '') {
        embedCode = '<script src="https://static.rndtech.de/share/rnd/datenrecherche/script/dw_chart_min.js" defer><\/script>\n<dw-chart\n    chart-id="{{ chart.chart_id }}">\n<\/dw-chart>';
      }
      
      // In die Zwischenablage kopieren
      navigator.clipboard.writeText(embedCode)
        .then(() => {
          // Erfolgs-Feedback anzeigen
          const notification = document.createElement('div');
          notification.innerHTML = "Einbettungscode kopiert!";
          notification.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #4f80ff;
            color: white;
            padding: 16px 32px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-family: 'DINNextLTPro', sans-serif;
            font-size: 1.1em;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
          `;
          document.body.appendChild(notification);
          
          // Animation ein und später aus
          setTimeout(() => { notification.style.opacity = '1'; }, 10);
          setTimeout(() => { 
            notification.style.opacity = '0'; 
            setTimeout(() => {
              document.body.removeChild(notification);
            }, 300);
          }, 2000);
        })
        .catch(err => {
          console.error('Fehler beim Kopieren: ', err);
        });
    }

    function handleIframe() {
      // iframe-URL aus der Datenbank holen
      const iframeCode = `{{ chart.iframe_url|escapejs }}`;
      
      // In die Zwischenablage kopieren
      navigator.clipboard.writeText(iframeCode)
        .then(() => {
          // Erfolgs-Feedback anzeigen
          const notification = document.createElement('div');
          notification.innerHTML = "iframe-URL kopiert!";
          notification.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #4f80ff;
            color: white;
            padding: 16px 32px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-family: 'DINNextLTPro', sans-serif;
            font-size: 1.1em;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
          `;
          document.body.appendChild(notification);
          
          // Animation ein und später aus
          setTimeout(() => { notification.style.opacity = '1'; }, 10);
          setTimeout(() => { 
            notification.style.opacity = '0'; 
            setTimeout(() => {
              document.body.removeChild(notification);
            }, 300);
          }, 2000);
        })
        .catch(err => {
          console.error('Fehler beim Kopieren: ', err);
        });
    }

    function handlePrint() {
      window.location.href = "{% url 'chart_print' chart.chart_id %}";
    }

    function handleSocial() {
      // Wird später implementiert
      console.log('Social Button clicked');
      alert('Social-Media Export wird vorbereitet...');
    }

    function goBack() {
      // Wenn es einen Suchbegriff im localStorage gibt, behalten wir ihn bei
      const searchQuery = localStorage.getItem('archiveSearchQuery');
      if (searchQuery) {
        // Wenn ein Referer vorhanden ist, war es wahrscheinlich die Archivseite
        if (document.referrer && document.referrer.includes('/archive')) {
          window.history.back();
          return false; // Verhindern, dass der Link normal navigiert
        }
        
        // Sonst zur Archivseite mit dem Suchbegriff in der URL zurückkehren
        window.location.href = "{% url 'archive_main' %}?q=" + encodeURIComponent(searchQuery);
        return false;
      }
      
      // Standard-Verhalten: zurück zur vorherigen Seite oder zur Archivseite
      if (document.referrer) {
        window.history.back();
        return false;
      }
      return true; // Normaler Link zur Archivseite
    }
  </script>
{% endblock %} 